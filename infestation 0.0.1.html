<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Infestation</title>
<style>
/* -------------------------------------------------------------
   GLOBAL LAYOUT
------------------------------------------------------------- */
body{
  margin:0;
  font-family:Arial,Helvetica,sans-serif;
  background:#111;
  color:#eee;
  overflow:hidden;
}
.screen{display:none;height:100vh;box-sizing:border-box;}
.active{display:flex;}

/* -------------------------------------------------------------
   START SCREEN
------------------------------------------------------------- */
#startScreen{
  flex-direction:column;
  justify-content:center;
  align-items:center;
  background:linear-gradient(135deg,#220022,#001122);
}
#startScreen h1{font-size:3rem;margin-bottom:.5rem;}
#startScreen p{font-size:1.2rem;max-width:500px;text-align:center;}
#startBtn{
  margin-top:2rem;padding:.8rem 1.6rem;font-size:1.2rem;
  background:#00ff00;color:#000;border:none;cursor:pointer;
  border-radius:.4rem;
}
#startBtn:hover{background:#33ff33;}

/* -------------------------------------------------------------
   MAIN GAME SCREEN (sidebar + main area)
------------------------------------------------------------- */
#gameScreen{flex-direction:row;}

/* ----- Sidebar (always visible) ----- */
#sidebar{
  width:300px;
  background:#1a1a2d;
  padding:1rem;
  box-sizing:border-box;
  overflow-y:auto;
}

/* ----- Header row (date | time | money) ----- */
#headerRow{
  display:flex;
  justify-content:space-between;
  font-size:.9rem;
  margin-bottom:1rem;
}

/* ----- Character description ----- */
#charDesc{
  font-size:.85rem;
  margin-bottom:.8rem;
  color:#88ff88;
}

/* -------------------------------------------------
   NEED LAYOUT – thin full‑width bar, name & label on ONE line
   ------------------------------------------------- */

.need{
  margin-bottom:0.2rem;
  position:relative;
}

/* header that holds the combined “Name: Label” line */
.needHeader{
  display:flex;
  justify-content:center;
  margin-bottom:0.2rem;               /* space between text and bar */
}

/* the single line – we’ll fill it via JS */
.needLine{
  font-size:.85rem;
  color:#fff;                      /* name part is white */
}

/* the label part (after the colon) will be coloured by JS */
.needLine .stage{
  color:#ccc;                      /* fallback colour */
}

/* thin, sharp‑edge bar */
.bar{
  width:100%;
  height:6px;                      /* thin rectangle */
  background:#444;
  overflow:hidden;
}

/* coloured fill – colour set by JS */
.fill{
  height:100%;
  display:block;
}

/* -------------------------------------------------
   HIDDEN (“bad”) needs – show only the stage label
   ------------------------------------------------- */
.noName .needLine{
  /* show the line (previously hidden) */
  display:flex;               /* keep flex so the label aligns nicely */
  justify-content:center;
  margin-left:0.2rem;         /* tiny indent so it lines up with other lines */
}

/* the stage label inside a hidden need – colour will be set by JS */
.noName .needLine .stage{
  /* fallback colour – will be overridden */
  color:#aaa;
}

/* -------------------------------------------------
   TOOLTIP (shows name in white + % in bar colour)
   ------------------------------------------------- */
.tooltip{
  position:absolute;
  left:50%;
  bottom:120%;
  transform:translateX(-50%);
  padding:.3rem .5rem;
  background:#222;
  color:#fff;
  font-size:.75rem;
  white-space:nowrap;
  border-radius:3px;
  opacity:0;
  pointer-events:none;
  transition:opacity .15s ease;
  z-index:10;
}
.tooltip::after{
  content:"";
  position:absolute;
  top:100%;
  left:50%;
  transform:translateX(-50%);
  border-width:5px 5px 0 5px;
  border-style:solid;
  border-color:#222 transparent transparent transparent;
}
.need:hover .tooltip{
  opacity:1;
}

/* ---- Bottom button bar – each button on its own row, full width ---- */
#bottomButtons{
  display:flex;
  flex-direction:column;          /* stack vertically */
  margin-top:9rem;
  gap:.4rem;
}

/* generic button – fills the whole row */
.bottomBtn{
  flex:1 0 auto;                  /* take full width of its row */
  width:100%;
  padding:.4rem .6rem;
  box-sizing:border-box;

  /* NEW – visual styling */
  background:#444;                /* dark‑gray background (feel free to adjust) */
  color:#fff;                     /* white text for contrast */
  border:2px solid transparent;   /* invisible border so the button size doesn’t jump on hover */
  border-radius:4px;              /* optional rounded corners */
  transition:border-color .15s ease, background .15s ease; /* smooth hover effect */
}

/* Hover state – green border */
.bottomBtn:hover{
  background:#555;                /* a slightly lighter gray while hovered (optional) */
  border-color:#00ff00;           /* bright green border on hover */
}
/* -----------------------------------------------------------------
   OVERLAY BUTTON STYLE – independent from the global style
   ----------------------------------------------------------------- */
.overlayBtn{
  /* Reset anything that the global .bottomBtn forced */
  width:auto !important;          /* ignore the global width:100% */
  flex:0 1 auto;                  /* allow shrinking, no forced growth */
  display:inline-block;           /* size to its intrinsic content */
  padding:.35rem .6rem;           /* comfortable click/tap area */
  margin:0 .2rem;                 /* tiny gap between neighbour elements */
  min-width:0;                    /* clear any inherited min‑width */
  box-sizing:border-box;          /* include padding in the width */
}

/* OPTIONAL: give overlay buttons a distinct look (colour, hover, etc.) */
.overlayBtn{
  background:#222;                /* darker background than sidebar buttons */
  color:#00ff00;                  /* bright green text – matches the UI theme */
  border:1px solid #00ff00;
  border-radius:4px;
}
.overlayBtn:hover{
  background:#333;
}

/* ---- Settings / Cheats when cheats are enabled ---------------------- */
/* the body gets the class “cheats-enabled” when the checkbox is ticked */
body.cheats-enabled #bottomButtons{
  flex-direction:row;             /* switch to a horizontal row */
  flex-wrap:wrap;
}

/* each takes ≈½ of the line */
body.cheats-enabled .settingsBtn,
body.cheats-enabled .cheatsBtn{
  flex:1 1 48%;                   /* half‑width, leave a tiny gap */
  width:auto;                    /* let flex control width */
}

/* keep the Settings button left‑aligned, Cheats button on the right */
body.cheats-enabled .settingsBtn{margin-right:auto;}
body.cheats-enabled .cheatsBtn{margin-left:auto;}

/* -------------------------------------------------------------
   MAIN AREA (rooms / events)
------------------------------------------------------------- */
#mainArea{
  flex:1;
  position:relative;
  padding:1.5rem;
  overflow-y:auto;
}

/* Text styles */
.eventTitle{font-size:1.8rem;margin-top:0;color:#00ff00;}
.eventText{margin:1rem 0;line-height:1.4;}
.link{color:#00ff00;cursor:pointer;text-decoration:underline;}
.link:hover{color:#33ff33;}

/* -------------------------------------------------------------
   NAVIGATION COLUMN (absolute, anchored below text)
------------------------------------------------------------- */
.navColumn{
  position:absolute;
  left:15%;
  display:flex;
  flex-direction:column;
  gap:.6rem;
}
.navColumn .link{font-size:1.1rem;}

/* -------------------------------------------------------------
   OVERLAY WINDOWS (square, 30 % of viewport width)
------------------------------------------------------------- */
.overlay{
  position:fixed;
  top:50%; left:50%;
  transform:translate(-50%,-50%);
  background:#222;
  border:2px solid #00ff00;
  padding:1rem;
  width:65vw;
  height:45vw;
  max-width:80;
  max-height:80;
  z-index:1000;
  display:none;
}
.overlayHeader{
  font-weight:bold;
  margin-bottom:.6rem;
  color:#00ff00;
}
.overlayClose{
  position:absolute;
  top:.4rem;
  right:.6rem;
  cursor:pointer;
  color:#ff5555;
}
.overlayBody{margin-top:1.2rem;}

/* -------------------------------------------------------------
   BOTTOM BUTTON BAR – definitions (kept for reference)
------------------------------------------------------------- */
/* (the actual buttons are now written directly in the HTML) */

/* -------------------------------------------------------------
   RESPONSIVE ADJUSTMENTS (optional)
------------------------------------------------------------- */
@media (max-width:600px){
  #sidebar{width:100%;height:auto;}
  #gameScreen{flex-direction:column;}
}
</style>
</head>
<body>

<!-- ==================== START SCREEN ==================== -->
<section id="startScreen" class="screen active">
  <h1>Infestation</h1>
  <p>
    Maya has been unlucky enough to become host to a worm‑like alien parasite.
    Manage her physical and mental state while she tries to uncover the truth.
  </p>
  <button id="startBtn">Begin</button>
</section>

<!-- ==================== MAIN GAME SCREEN ==================== -->
<section id="gameScreen" class="screen">
  <!-- ---------- Sidebar (always visible) ---------- -->
  <aside id="sidebar">
    <h3>Game Info</h3>

    <!-- Header row: Date | Time | Money -->
    <div id="headerRow">
      <span id="date">01 Aug 2025</span>
      <span id="clock">09:00</span>
      <span id="money">$0.00</span>
    </div>

    <!-- Character description -->
    <div id="charDesc">Wearing: lab coat, sneakers</div>

<!-- ==================== NEED CONTAINERS (NEW LAYOUT) ==================== -->

<!-- regular needs -->
<div class="need" id="need-tiredness"
     data-name="Fatigue"
     data-labels="Exhausted|Very Tired|Tired|Alert|Energized">
  <div class="needHeader">
    <span class="needLine"><!-- filled by JS --> </span>
  </div>
  <div class="bar"><span class="fill"></span></div>
  <div class="tooltip"></div>
</div>

<div class="need" id="need-stress"
     data-name="Stress"
     data-labels="Panicked|Very Stressed|Stressed|Calm|Relaxed">
  <div class="needHeader">
    <span class="needLine"></span>
  </div>
  <div class="bar"><span class="fill"></span></div>
  <div class="tooltip"></div>
</div>

<div class="need" id="need-trauma"
     data-name="Trauma"
     data-labels="Shattered|Severely Traumatized|Traumatized|Stable|Secure">
  <div class="needHeader">
    <span class="needLine"></span>
  </div>
  <div class="bar"><span class="fill"></span></div>
  <div class="tooltip"></div>
</div>

<div class="need" id="need-happiness"
     data-name="Happiness"
     data-labels="Depressed|Very Unhappy|Unhappy|Content|Joyful">
  <div class="needHeader">
    <span class="needLine"></span>
  </div>
  <div class="bar"><span class="fill"></span></div>
  <div class="tooltip"></div>
</div>

<div class="need" id="need-arousal"
     data-name="Arousal"
     data-labels="Numb|Very Low|Low|Normal|High">
  <div class="needHeader">
    <span class="needLine"></span>
  </div>
  <div class="bar"><span class="fill"></span></div>
  <div class="tooltip"></div>
</div>

<!-- hidden / “bad” needs – keep hidden until shown -->
<div class="need hiddenBar noName" id="need-corruption"
     data-name="Corruption"
     data-labels="None|Trace|Low|Medium|High">
  <div class="needHeader"><span class="needLine"></span></div>
  <div class="bar"><span class="fill"></span></div>
  <div class="tooltip"></div>
</div>

<div class="need hiddenBar noName" id="need-alcohol"
     data-name="Alcohol"
     data-labels="Sober|Buzzed|Tipsy|Drunk|Wasted">
  <div class="needHeader"><span class="needLine"></span></div>
  <div class="bar"><span class="fill"></span></div>
  <div class="tooltip"></div>
</div>

<div class="need hiddenBar noName" id="need-drugs"
     data-name="Drugs"
     data-labels="Clean|Mild|Moderate|Heavy|Overdose">
  <div class="needHeader"><span class="needLine"></span></div>
  <div class="bar"><span class="fill"></span></div>
  <div class="tooltip"></div>
</div>

    <!-- Bottom button bar (static HTML – JS will attach handlers) -->
    <div id="bottomButtons">
      <button id="btnChar"    class="bottomBtn">Character</button>
      <button id="btnSocial"  class="bottomBtn">Social</button>
      <button id="btnJournal" class="bottomBtn">Journal</button>
      <button id="btnSaves"   class="bottomBtn">Saves</button>

      <!-- Settings button – always visible -->
      <button id="btnSettings" class="bottomBtn settingsBtn">Settings</button>

      <!-- Cheats button – hidden until checkbox is ticked -->
      <button id="cheatsBtn"   class="bottomBtn cheatsBtn" style="display:none;">Cheats</button>
    </div>
  </aside>
<!-- CHARACTER overlay -->
<div id="btnChar-overlay" class="overlay">
  <div class="overlayHeader">Character</div>
  <div class="overlayClose" onclick="closeAllOverlays()">✖</div>
  <div class="overlayBody">
    <div id="char-buttons" style="display: flex; justify-content: space-between; margin-bottom: 1rem; gap: 0.5rem;">
        <button class="overlayBtn" style="flex-grow: 1;" onclick="showCharTab('status')">Status</button>
        <button class="overlayBtn" style="flex-grow: 1;" onclick="showCharTab('skills')">Skills</button>
        <button class="overlayBtn" style="flex-grow: 1;" onclick="showCharTab('stats')">Stats</button>
    </div>
    <div id="char-status" class="char-tab"></div>
    <div id="char-skills" class="char-tab" style="display: none;"></div>
    <div id="char-stats" class="char-tab" style="display: none;"></div>
  </div>
</div>


<!-- SOCIAL overlay -->
<div id="btnSocial-overlay" class="overlay">
  <div class="overlayHeader">Social</div>
  <div class="overlayClose" onclick="closeAllOverlays()">✖</div>
  <div class="overlayBody"></div>
</div>

<!-- JOURNAL overlay -->
<div id="btnJournal-overlay" class="overlay">
  <div class="overlayHeader">Journal</div>
  <div class="overlayClose" onclick="closeAllOverlays()">✖</div>
  <div class="overlayBody"></div>
</div>

<!-- SAVES overlay -->
<div id="btnSaves-overlay" class="overlay">
  <div class="overlayHeader">Saves</div>
  <div class="overlayClose" onclick="closeAllOverlays()">✖</div>
  <div class="overlayBody"></div>
</div>
  <!-- ---------- Main area (events / rooms) ---------- -->
  <main id="mainArea">
    <!-- Content will be injected by JavaScript -->
  </main>
</section>

<!-- SETTINGS overlay (square, 30 % of viewport width) -->
<div id="btnSettings-overlay" class="overlay settingsOverlay">
  <div class="overlayHeader">Settings</div>
  <div class="overlayClose" onclick="closeAllOverlays()">✖</div>
  <div class="overlayBody">
    <label style="display:flex;align-items:center;gap:.4rem;">
      <input type="checkbox" id="cheatsChk" onchange="toggleCheats(this)">
      Enable Cheats
    </label>
  </div>
</div>

<!-- CHEATS overlay (same square size) -->
<div id="cheatsBtn-overlay" class="overlay cheatsOverlay">
  <div class="overlayHeader">Cheats</div>
  <div class="overlayClose" onclick="closeAllOverlays()">✖</div>
  <div class="overlayBody">
    <!-- Cheat controls will be inserted by JS later -->
  </div>
</div>
<script>
/* ==============================================================
   GLOBAL STATE
   ============================================================== */
const state = {
  /* -------------------- Time -------------------- */
  currentTime: new Date('2007-08-01T09:00:00'),   // start time (unchanged)

  /* -------------------- Money ------------------- */
  money: 0.00,

  /* -------------------- Intro events ------------ */
  eventIndex: 0,
  events: [
    {title:"Meet Maya",text:"Maya Alvarez, a marine biologist, woke up feeling a strange pressure in her abdomen. An alien worm‑like parasite has taken residence inside her, feeding off her nervous system."},
    {title:"Friend – Leah",text:"Leah Patel, Maya’s longtime friend, calls to check in. She senses something is off but Maya brushes it aside."},
    {title:"Friend – Amir",text:"Dr. Amir Khan, a neuro‑biology researcher, offers to run scans. He warns Maya about the risks of unknown pathogens."},
    {title:"Friend – Toby",text:"Toby, the lab’s tech specialist, jokes about “alien pets.” He hands Maya a bottle of energy drink."}
  ],

  /* -------------------- Needs ------------------- */
  needs: {
    tiredness: 10000,
    stress: 0,
    trauma: 0,
    happiness: 1000,
    arousal: 0,
    corruption: 0,
    alcohol: 0,
    drugs: 0
  },

  ranges: {
    tiredness: 10000,
    stress: 1000,
    trauma: 1000,
    happiness: 1000,
    arousal: 1000,
    corruption: 1000,
    alcohol: 100,
    drugs: 100
  },

  /* -------------------- Flags -------------------- */
  showCorruption: false,   // toggled from Cheats overlay
  cheatsEnabled: false,     // set by Settings → Enable Cheats

  /* -------------------- Skills ------------------- */
  skills: {
    "PH skill 1": { level: 1, exp: 0 }, "PH skill 2": { level: 1, exp: 0 }, "PH skill 3": { level: 1, exp: 0 }, "PH skill 4": { level: 1, exp: 0 }, "PH skill 5": { level: 1, exp: 0 },
    "PH skill 6": { level: 1, exp: 0 }, "PH skill 7": { level: 1, exp: 0 }, "PH skill 8": { level: 1, exp: 0 }, "PH skill 9": { level: 1, exp: 0 }, "PH skill 10": { level: 1, exp: 0 },
    "PH skill 11": { level: 1, exp: 0 }, "PH skill 12": { level: 1, exp: 0 }, "PH skill 13": { level: 1, exp: 0 }, "PH skill 14": { level: 1, exp: 0 }, "PH skill 15": { level: 1, exp: 0 },
    "PH skill 16": { level: 1, exp: 0 }, "PH skill 17": { level: 1, exp: 0 }, "PH skill 18": { level: 1, exp: 0 }, "PH skill 19": { level: 1, exp: 0 }, "PH skill 20": { level: 1, exp: 0 },
    "PH skill 21": { level: 1, exp: 0 }, "PH skill 22": { level: 1, exp: 0 }, "PH skill 23": { level: 1, exp: 0 }, "PH skill 24": { level: 1, exp: 0 }, "PH skill 25": { level: 1, exp: 0 },
    "PH skill 26": { level: 1, exp: 0 }, "PH skill 27": { level: 1, exp: 0 }, "PH skill 28": { level: 1, exp: 0 }, "PH skill 29": { level: 1, exp: 0 }, "PH skill 30": { level: 1, exp: 0 },
    "PH skill 31": { level: 1, exp: 0 }, "PH skill 32": { level: 1, exp: 0 }, "PH skill 33": { level: 1, exp: 0 }, "PH skill 34": { level: 1, exp: 0 }, "PH skill 35": { level: 1, exp: 0 },
    "PH skill 36": { level: 1, exp: 0 }, "PH skill 37": { level: 1, exp: 0 }, "PH skill 38": { level: 1, exp: 0 }, "PH skill 39": { level: 1, exp: 0 }, "PH skill 40": { level: 1, exp: 0 },
    "PH skill 41": { level: 1, exp: 0 }, "PH skill 42": { level: 1, exp: 0 }, "PH skill 43": { level: 1, exp: 0 }, "PH skill 44": { level: 1, exp: 0 }, "PH skill 45": { level: 1, exp: 0 },
    "PH skill 46": { level: 1, exp: 0 }, "PH skill 47": { level: 1, exp: 0 }, "PH skill 48": { level: 1, exp: 0 }, "PH skill 49": { level: 1, exp: 0 }, "PH skill 50": { level: 1, exp: 0 }
  },

  /* -------------------- Stats -------------------- */
  stats: {
    timesSlept: 0,
    questsCompleted: 0,
    itemsCrafted: 0,
    distanceWalked: 0
  },

  /* -------------------- NPCs --------------------- */
  npcs: {
    "Leah": { relationship: 50, trust: 30, fear: 0, attraction: 20, hidden: true },
    "Amir": { relationship: 40, trust: 60, fear: 10, attraction: 10, hidden: true },
    "Toby": { relationship: 25, trust: 20, fear: 0, attraction: 5, hidden: true }
  },

  /* -------------------- Journal ------------------ */
  journal: {
    quests: [
      { title: "Uncover the Truth", description: "Find out more about the alien parasite and its origins.", complete: false }
    ],
    reminders: [],
    notes: "I can write my own notes here."
  },

  /* -------------------- Game Location ------------------ */
  currentLocation: 'event_intro'
};

/* ==============================================================
   UTILS
   ============================================================== */
function fmtHM(d){ return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',hour12:false}); }
function fmtDate(d){ return d.toLocaleDateString(); }

/* Add 30 seconds to the clock and refresh the header */
function advanceTime(){
  state.currentTime = new Date(state.currentTime.getTime() + 30_000);
  updateHeader();
}

/* ==============================================================
   SKILL SYSTEM UTILS
   ============================================================== */
function getExpForLevel(level) {
  if (level >= 20) return Infinity;
  return 8 * Math.pow(2, level - 1);
}

function addSkillExp(skillName, amount) {
  const skill = state.skills[skillName];
  if (!skill || skill.level >= 20) return;

  skill.exp += amount;
  let expToLevelUp = getExpForLevel(skill.level);

  while (skill.exp >= expToLevelUp) {
    skill.level++;
    skill.exp -= expToLevelUp;
    
    if (skill.level >= 20) {
      skill.exp = getExpForLevel(19);
      return; 
    }
    expToLevelUp = getExpForLevel(skill.level);
  }
}

/* ==============================================================
   CHARACTER WINDOW
   ============================================================== */
function showCharTab(tabName) {
    document.querySelectorAll('.char-tab').forEach(t => t.style.display = 'none');
    const tab = document.getElementById(`char-${tabName}`);
    if (tab) tab.style.display = 'block';
    
    if (tabName === 'status') updateCharStatusTab();
    else if (tabName === 'skills') updateCharSkillsTab();
    else if (tabName === 'stats') updateCharStatsTab();
}

function updateCharStatusTab() {
    const statusDiv = document.getElementById('char-status');
    if (!statusDiv) return;
    let text = "Maya is feeling ";
    const tirednessPct = getFillPct('tiredness');
    if (tirednessPct <= 20) text += "exhausted";
    else if (tirednessPct <= 50) text += "tired";
    else text += "well-rested";

    const stressPct = getFillPct('stress');
    if (stressPct > 80) text += " and is panicking.";
    else if (stressPct > 50) text += " and feels very stressed.";
    else text += ".";
    
    statusDiv.textContent = text;
}

function updateCharSkillsTab() {
    const skillsDiv = document.getElementById('char-skills');
    if (!skillsDiv) return;
    let html = '<div style="display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center;">';

    for (const skillName in state.skills) {
        const skill = state.skills[skillName];
        const expForNextLevel = getExpForLevel(skill.level);
        const progress = skill.level >= 20 ? 100 : Math.round((skill.exp / expForNextLevel) * 100);

        html += `
            <div style="border: 1px solid #444; padding: 0.5rem; width: 120px; box-sizing: border-box; text-align: center;">
                <div style="font-size: 0.8rem;">${skillName}<br>(Lvl ${skill.level})</div>
                <div style="background: #333; height: 10px; margin-top: 5px; border-radius: 2px; overflow: hidden;">
                    <div style="width: ${progress}%; height: 100%; background: lightblue; border-radius: 2px;"></div>
                </div>
            </div>
        `;
    }
    html += '</div>';
    skillsDiv.innerHTML = html;
}

function updateCharStatsTab() {
    const statsDiv = document.getElementById('char-stats');
    if (!statsDiv) return;
    let html = '<ul style="list-style-position: inside;">';
    for (const statName in state.stats) {
        const statValue = state.stats[statName];
        const formattedName = statName.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
        html += `<li>${formattedName}: ${statValue}</li>`;
    }
    html += '</ul>';
    statsDiv.innerHTML = html;
}

/* ==============================================================
   SOCIAL
   ============================================================== */
function buildSocialOverlay() {
    const body = document.querySelector('#btnSocial-overlay .overlayBody');
    if (!body) return;

    let html = '<div class="npc-grid" style="display: flex; flex-wrap: wrap; gap: 1rem; align-content: flex-start; height: 100%; overflow-y: auto;">';

    for (const npcName in state.npcs) {
        const npc = state.npcs[npcName];
        
        html += `<div class="npc-plate" style="border: 1px solid #444; padding: 1rem; width: 22%; box-sizing: border-box; min-height: 160px; display: flex; flex-direction: column; justify-content: space-between;">`;
        
        html += `<div><h4>${npcName}</h4>`;

        if (npc.hidden) {
            html += `<p style="font-size: 0.9em; color: #aaa;">Stats are hidden.</p>`;
        } else {
            // Using placeholder colors here.
            html += createNpcStatBar('Love', npc.relationship, '#ff0000'); // Red
            html += createNpcStatBar('Lust', npc.attraction, '#ff69b4');   // Hot Pink
            html += createNpcStatBar('Trust', npc.trust, '#1e90ff');     // Dodger Blue
            html += createNpcStatBar('Fear', npc.fear, '#9932cc');       // Dark Orchid
        }
        html += `</div>`;

        if (npc.hidden) {
            const buttonId = `reveal-btn-${npcName.replace(/\s/g, '-')}`;
            html += `<button id="${buttonId}" class="overlayBtn" style="width: 100%; margin-top: 1rem;">Reveal Stats</button>`;
        }
        
        html += `</div>`;
    }
    html += '</div>';

    body.innerHTML = html;

    // --- Attach Event Listeners ---
    for (const npcName in state.npcs) {
        if (state.npcs[npcName].hidden) {
            const buttonId = `reveal-btn-${npcName.replace(/\s/g, '-')}`;
            const btn = document.getElementById(buttonId);
            if (btn) {
                btn.addEventListener('click', () => {
                    if (state.npcs[npcName]) {
                        state.npcs[npcName].hidden = false;
                        buildSocialOverlay();
                    }
                });
            }
        }
    }
}

function createNpcStatBar(statName, value, barColor = '#4a90e2') {
    const percentage = Math.max(0, Math.min(100, value));

    return `
        <div class="npc-stat-bar-container" style="display: flex; align-items: center; margin-bottom: 0.3rem;">
            <span style="width: 80px; font-size: 0.9em; text-align: right; margin-right: 5px;">${statName}</span>
            <div class="bar" style="flex-grow: 1; height: 8px; background: #444; border-radius: 2px;">
                <div class="fill" style="width: ${percentage}%; height: 100%; background: ${barColor}; border-radius: 2px;"></div>
            </div>
        </div>
    `;
}
function cheatAddAllSkillsExp(amount) {
    for (const skillName in state.skills) {
        addSkillExp(skillName, amount);
    }
    // Visually update the character screen if it's open
    if (document.getElementById('btnChar-overlay').style.display === 'block') {
        updateCharSkillsTab();
    }
}



/* ==============================================================
   HEADER (date | time | money)
   ============================================================== */
function updateHeader(){
  document.getElementById('clock').textContent = fmtHM(state.currentTime);
  document.getElementById('date' ).textContent = fmtDate(state.currentTime);
  document.getElementById('money').textContent = `$${state.money.toFixed(2)}`;
}

/* ==============================================================
   NEEDS UI
   ============================================================== */
function getFillPct(k){
  const cur = state.needs[k];
  const max = state.ranges[k];
  return Math.min(100, Math.max(0, (cur / max) * 100));
}

/* Simple stage labels (just for visual flavour) */
function stageLabel(p){
  if(p===0) return 'Stage 0';
  if(p<=33) return 'Stage 1';
  if(p<=66) return 'Stage 2';
  if(p<=99) return 'Stage 3';
  if(p=100) return 'Stage 4';
}

function updateNeedsUI(){
  Object.keys(state.needs).forEach(k=>{
    const el   = document.getElementById(`need-${k}`);
    if(!el) return;

    const pct  = getFillPct(k);                     // 0‑100 %
    const fill = el.querySelector('.fill');
    const line = el.querySelector('.needLine');

/* ---------- colour (custom logic) ---------- */
const inverted = ['stress','trauma','arousal'].includes(k);
const barColor =
  k === 'corruption' ? 'purple' :
  k === 'alcohol' ? 'orange' :
  k === 'drugs' ? 'lightsalmon' :
  (() => {
    const r = Math.round(255 * (inverted ? pct/100 : 1-pct/100));
    const g = Math.round(255 * (inverted ? 1-pct/100 : pct/100));
    return `rgb(${r},${g},0)`;
  })();

    fill.style.width = pct + '%';
    fill.style.background = barColor;               // thin bar colour
    

    /* ---------- stage label ---------- */
    const labels = el.getAttribute('data-labels').split('|');
    const idx = Math.min(labels.length-1, Math.floor(pct/20)); // 0‑4
    const stage = labels[idx];

    /* ---------- compose “Name: Stage” line ----------
       – for normal needs we show the name, for hidden ones we hide it
    */
    const needName = el.getAttribute('data-name');
    if(el.classList.contains('noName')){
      // hidden needs: only the stage (no name)
      line.innerHTML = `<span class="stage" style="color:${barColor};">${stage}</span>`;
    }else{
      // normal needs: “Name: Stage” on one line
      line.innerHTML = `
        <span style="color:#fff;">${needName}:</span>
        <span class="stage" style="color:${barColor}; margin-left:.4rem;">${stage}</span>
      `;
    }

    /* ---------- tooltip (name white + % coloured) ---------- */
    const tooltip = el.querySelector('.tooltip');
    tooltip.innerHTML = `
      <span style="color:#fff;">${needName}</span>
      <span style="color:${barColor}; margin-left:.4rem;">${pct.toFixed(0)}%</span>
    `;

    /* ---------- empty‑text colour handling (unchanged) ---------- */
    if(!inverted && pct===0 && !el.classList.contains('noName')){
      line.classList.add('empty');
    }else{
      line.classList.remove('empty');
    }
  });

  /* ---- visibility of the “bad” needs (unchanged) ---- */
  document.getElementById('need-alcohol')
          .style.display = state.needs.alcohol>0 ? 'block' : 'none';
  document.getElementById('need-drugs')
          .style.display = state.needs.drugs>0 ? 'block' : 'none';

  const corr = document.getElementById('need-corruption');
  if(state.showCorruption){
    corr.classList.remove('hiddenBar');
    corr.style.display = 'block';
  }else{
    corr.classList.add('hiddenBar');
    corr.style.display = 'none';
  }
}

/* ==============================================================
   SCREEN SWITCHING
   ============================================================== */
function switchScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

/* ==============================================================
   INTRO EVENT SEQUENCE (no time advance while reading)
   ============================================================== */
function showCurrentEvent(){
  const c = document.getElementById('mainArea');
  c.innerHTML = '';

  const ev = state.events[state.eventIndex];

  const title = document.createElement('h2');
  title.className = 'eventTitle';
  title.textContent = ev.title;
  c.appendChild(title);

  const txt = document.createElement('p');
  txt.className = 'eventText';
  txt.textContent = ev.text;
  c.appendChild(txt);

  const link = document.createElement('span');
  link.className = 'link';
  link.textContent = (state.eventIndex < state.events.length-1) ? 'Continue →' : 'Enter the Lab →';
  link.onclick = () => {
    if(state.eventIndex < state.events.length-1){
      state.eventIndex++;
      showCurrentEvent();          // **no** advanceTime here
    }else{
      renderFoyer();               // entering the lab starts the map
    }
  };
  c.appendChild(link);
}

/* ==============================================================
   MAP – FOYER AND ROOMS (each move advances time)
   ============================================================== */
function renderFoyer(){
  const c = document.getElementById('mainArea');
  c.innerHTML = `
    <h2 class="eventTitle">Laboratory Foyer</h2>
    <p class="eventText" id="foyerDesc">
      The foyer is dimly lit, metal doors line the walls, and a low hum of equipment
      reverberates through the concrete floor. A faint smell of antiseptic hangs in the air.
    </p>
    <div class="navColumn" id="foyerNav"></div>
  `;
  const nav = document.getElementById('foyerNav');
  nav.innerHTML = `
    <span class="link" onclick="renderRoom('kitchen')">Kitchen</span>
    <span class="link" onclick="renderRoom('lounge')">Lounge</span>
    <span class="link" onclick="renderRoom('bathroom')">Bathroom</span>
  `;
  positionNavBelow(document.getElementById('foyerDesc'), nav);
  advanceTime();                     // moving into the foyer costs 30 s
}

function renderRoom(name){
  const c = document.getElementById('mainArea');
  let title='',desc='';

  if(name==='kitchen'){
    title='Kitchen';
    desc=`Stainless steel counters glint under harsh fluorescent lights. A coffee maker gurgles,
           and a half‑eaten sandwich rests on a plate. The scent of stale coffee lingers.
           The fridge hums softly, casting a faint blue glow across the tiled floor.`;
  }else if(name==='lounge'){
    title='Lounge';
    desc=`Plush chairs face a wall‑mounted screen playing calming nature footage.
           Shelves hold scientific journals and a few well‑worn novels. Soft ambient music drifts.`;
  }else if(name==='bathroom'){
    title='Bathroom';
    desc=`White tiles line the walls, a single sink flickers with a weak bulb. The mirror fogs
           slightly as warm air circulates. A small cabinet holds basic toiletries.`;
  }

  c.innerHTML = `
    <h2 class="eventTitle">${title}</h2>
    <p class="eventText" id="roomDesc">${desc}</p>
    <div class="navColumn" id="roomNav"></div>
  `;
  const nav = document.getElementById('roomNav');
  nav.innerHTML = `<span class="link" onclick="renderFoyer()">Back to Foyer</span>`;
  positionNavBelow(document.getElementById('roomDesc'), nav);
  advanceTime();                     // each room transition adds 30 s
}

/* Helper – positions a .navColumn just below a given element */
function positionNavBelow(targetEl, navEl){
  const parent = document.getElementById('mainArea').getBoundingClientRect();
  const tgt    = targetEl.getBoundingClientRect();
  const pct = ((tgt.bottom - parent.top) / parent.height) * 100;
  navEl.style.top = `${pct + 2}%`;   // small gap
}

/* ==============================================================
   BOTTOM BUTTONS & OVERLAYS
   ============================================================== */
function initBottomButtons(){
  // Character / Social / Journal / Saves – placeholder handlers (you can flesh out)
  document.getElementById('btnChar'   ).onclick = () => openOverlay('btnChar');
  document.getElementById('btnSocial' ).onclick = () => openOverlay('btnSocial');
  document.getElementById('btnJournal').onclick = () => openOverlay('btnJournal');
  document.getElementById('btnSaves'  ).onclick = () => openOverlay('btnSaves');

  // Settings button – opens its overlay
  document.getElementById('btnSettings').onclick = () => openOverlay('btnSettings');

  // Cheats button – appears only after the checkbox is ticked
  document.getElementById('cheatsBtn'  ).onclick = () => openOverlay('cheatsBtn');
}

/* Generic overlay toggler (click again to hide) */
function openOverlay(btnId){
  const ov = document.getElementById(`${btnId}-overlay`);
  if(!ov) return;

  if(ov.style.display === 'block'){
    ov.style.display = 'none';
  }else{
    closeAllOverlays();
    ov.style.display = 'block';

    // Populate overlays with dynamic content when they are opened
    if (btnId === 'btnChar') {
        showCharTab('status');
    } else if (btnId === 'btnSocial') {
        buildSocialOverlay();
    }
  }
}

/* Hide every overlay */
function closeAllOverlays(){
  document.querySelectorAll('.overlay').forEach(o=>o.style.display='none');
}

/* --------------------------------------------------------------
   SETTINGS → CHEATS CHECKBOX
   -------------------------------------------------------------- */
function toggleCheats(cb){
  state.cheatsEnabled = cb.checked;

  // add/remove a class that drives the CSS layout
  if(state.cheatsEnabled) document.body.classList.add('cheats-enabled');
  else                       document.body.classList.remove('cheats-enabled');

  // show / hide the Cheats button (CSS already handles width)
  document.getElementById('cheatsBtn').style.display = state.cheatsEnabled ? 'inline-block' : 'none';
}

/* --------------------------------------------------------------
   CHEAT OVERLAY & HELPERS
   -------------------------------------------------------------- */
function cheatModifyNpcStat(npcName, stat, amount) {
    if (state.npcs[npcName]) {
        state.npcs[npcName][stat] = Math.max(0, Math.min(100, state.npcs[npcName][stat] + amount));
        buildCheatOverlay(); // Redraw cheats to update value
        if (document.getElementById('btnSocial-overlay').style.display === 'block') {
            buildSocialOverlay();
        }
    }
}

function cheatModifyNeed(key, delta) {
  const max = state.ranges[key];
  const min = 0;
  state.needs[key] = Math.min(max, Math.max(min, state.needs[key] + delta));
  updateNeedsUI();
  buildCheatOverlay(); // Redraw cheats to update value
}

// This helper function creates the new standardized row for any cheat
function createCheatControlRow(config) {
    // config: { label, value, neg_actions, pos_actions }
    return `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.4rem 0.2rem; border-bottom: 1px solid #333;">
            <span style="flex-basis: 30%; font-size: 0.9em;">${config.label}</span>
            <div style="flex-basis: 70%; display: flex; justify-content: flex-end; align-items: center; gap: 0.3rem;">
                <button class="overlayBtn" onclick="${config.neg_actions[0].onclick}">${config.neg_actions[0].label}</button>
                <button class="overlayBtn" onclick="${config.neg_actions[1].onclick}">${config.neg_actions[1].label}</button>
                <button class="overlayBtn" onclick="${config.neg_actions[2].onclick}">${config.neg_actions[2].label}</button>
                <span style="min-width: 6ch; text-align: center; font-weight: bold;">${config.value}</span>
                <button class="overlayBtn" onclick="${config.pos_actions[0].onclick}">${config.pos_actions[0].label}</button>
                <button class="overlayBtn" onclick="${config.pos_actions[1].onclick}">${config.pos_actions[1].label}</button>
                <button class="overlayBtn" onclick="${config.pos_actions[2].onclick}">${config.pos_actions[2].label}</button>
            </div>
        </div>
    `;
}

function showCheatTab(tabName) {
    document.querySelectorAll('.cheat-tab-content').forEach(el => el.style.display = 'none');
    document.getElementById(`cheat-tab-${tabName}`).style.display = 'block';
}

function buildCheatOverlay() {
    const body = document.querySelector('#cheatsBtn-overlay .overlayBody');
    body.style.height = 'calc(100% - 2rem)';
    body.style.overflowY = 'hidden';

    // --- Tab Setup ---
    body.innerHTML = `
        <div id="cheat-tabs" style="display: flex; justify-content: center; margin-bottom: 1rem; gap: 0.5rem;">
            <button class="overlayBtn" style="flex-grow: 1;" onclick="showCheatTab('general')">General</button>
            <button class="overlayBtn" style="flex-grow: 1;" onclick="showCheatTab('skills')">Skills</button>
            <button class="overlayBtn" style="flex-grow: 1;" onclick="showCheatTab('npcs')">NPCs</button>
        </div>
        <div id="cheat-tab-general" class="cheat-tab-content" style="height: 90%; overflow-y: auto;"></div>
        <div id="cheat-tab-skills" class="cheat-tab-content" style="display: none; height: 90%; overflow-y: auto;"></div>
        <div id="cheat-tab-npcs" class="cheat-tab-content" style="display: none; height: 90%; overflow-y: auto;"></div>
    `;

    // --- Build General Tab ---
    const generalTab = document.getElementById('cheat-tab-general');
    let generalContent = '<div style="display: flex; gap: 2rem;">';

    // Left Column
    let leftCol = '<div style="flex-basis: 50%;">';
    leftCol += '<h4 style="text-align: center;">Needs</h4>';
    for (const key in state.needs) {
        const max = state.ranges[key];
        leftCol += createCheatControlRow({
            label: key.charAt(0).toUpperCase() + key.slice(1),
            value: `${state.needs[key].toFixed(0)}`,
            neg_actions: [ { label: '-50%', onclick: `cheatModifyNeed('${key}', -${max*0.5})` }, { label: '-10%', onclick: `cheatModifyNeed('${key}', -${max*0.1})` }, { label: '-1%', onclick: `cheatModifyNeed('${key}', -${max*0.01})` } ],
            pos_actions: [ { label: '+1%', onclick: `cheatModifyNeed('${key}', ${max*0.01})` }, { label: '+10%', onclick: `cheatModifyNeed('${key}', ${max*0.1})` }, { label: '+50%', onclick: `cheatModifyNeed('${key}', ${max*0.5})` } ]
        });
    }
    leftCol += '</div>';

    // Right Column
    let rightCol = '<div style="flex-basis: 50%;">';
    rightCol += '<h4 style="text-align: center;">Money & Toggles</h4>';
    rightCol += createCheatControlRow({
        label: "Money", value: `$${state.money.toFixed(2)}`,
        neg_actions: [ { label: '-1k', onclick: `cheatMoney(-1000)` }, { label: '-100', onclick: `cheatMoney(-100)` }, { label: '-10', onclick: `cheatMoney(-10)` } ],
        pos_actions: [ { label: '+10', onclick: `cheatMoney(10)` }, { label: '+100', onclick: `cheatMoney(100)` }, { label: '+1k', onclick: `cheatMoney(1000)` } ]
    });
    rightCol += `<div style="text-align: center; padding: 1rem;"><label><input type="checkbox" onchange="toggleCorruptionDisplay(this)" ${state.showCorruption?'checked':''}> Show Corruption Bar</label></div>`;
    rightCol += '</div>';

    generalContent += leftCol + rightCol + '</div>';
    generalTab.innerHTML = generalContent;


    // --- Build Skills Tab (2 columns) ---
    const skillsTab = document.getElementById('cheat-tab-skills');
    let skillsHtml = '<h4 style="text-align: center;">Skills</h4><div style="display: flex; gap: 1rem;">';
    const skills = Object.keys(state.skills);
    const mid = Math.ceil(skills.length / 2);
    const col1 = skills.slice(0, mid);
    const col2 = skills.slice(mid);
    let col1Html = '<div style="flex-basis: 50%;">';
    col1.forEach(skillName => {
        col1Html += createCheatControlRow({
            label: skillName, value: `${state.skills[skillName].exp.toFixed(0)} exp`,
            neg_actions: [ {label: '-64', onclick:`addSkillExp('${skillName}', -64)`}, {label: '-8', onclick:`addSkillExp('${skillName}', -8)`}, {label: '-1', onclick:`addSkillExp('${skillName}', -1)`} ],
            pos_actions: [ {label: '+1', onclick:`addSkillExp('${skillName}', 1)`}, {label: '+8', onclick:`addSkillExp('${skillName}', 8)`}, {label: '+64', onclick:`addSkillExp('${skillName}', 64)`} ],
        });
    });
    col1Html += '</div>';
    let col2Html = '<div style="flex-basis: 50%;">';
    col2.forEach(skillName => {
        col2Html += createCheatControlRow({
            label: skillName, value: `${state.skills[skillName].exp.toFixed(0)} exp`,
            neg_actions: [ {label: '-64', onclick:`addSkillExp('${skillName}', -64)`}, {label: '-8', onclick:`addSkillExp('${skillName}', -8)`}, {label: '-1', onclick:`addSkillExp('${skillName}', -1)`} ],
            pos_actions: [ {label: '+1', onclick:`addSkillExp('${skillName}', 1)`}, {label: '+8', onclick:`addSkillExp('${skillName}', 8)`}, {label: '+64', onclick:`addSkillExp('${skillName}', 64)`} ],
        });
    });
    col2Html += '</div>';
    skillsTab.innerHTML = skillsHtml + col1Html + col2Html + '</div>';

    // --- Build NPCs Tab (2 columns) ---
    const npcsTab = document.getElementById('cheat-tab-npcs');
    let npcsHtml = '<h4 style="text-align: center;">NPCs</h4><div style="display: flex; gap: 1rem;">';
    const npcs = Object.keys(state.npcs);
    const npcMid = Math.ceil(npcs.length / 2);
    const npcCol1 = npcs.slice(0, npcMid);
    const npcCol2 = npcs.slice(npcMid);
    let npcCol1Html = '<div style="flex-basis: 50%;">';
    npcCol1.forEach(npcName => {
        npcCol1Html += `<h5 style="text-align:center;">${npcName}</h5>`;
        for(const stat in state.npcs[npcName]) {
            if(typeof state.npcs[npcName][stat] === 'number') {
                npcCol1Html += createCheatControlRow({
                    label: stat.charAt(0).toUpperCase() + stat.slice(1), value: state.npcs[npcName][stat],
                    neg_actions: [ {label: '-25', onclick:`cheatModifyNpcStat('${npcName}', '${stat}', -25)`}, {label: '-5', onclick:`cheatModifyNpcStat('${npcName}', '${stat}', -5)`}, {label: '-1', onclick:`cheatModifyNpcStat('${npcName}', '${stat}', -1)`} ],
                    pos_actions: [ {label: '+1', onclick:`cheatModifyNpcStat('${npcName}', '${stat}', 1)`}, {label: '+5', onclick:`cheatModifyNpcStat('${npcName}', '${stat}', 5)`}, {label: '+25', onclick:`cheatModifyNpcStat('${npcName}', '${stat}', 25)`} ]
                });
            }
        }
    });
    npcCol1Html += '</div>';
    let npcCol2Html = '<div style="flex-basis: 50%;">';
    npcCol2.forEach(npcName => {
        npcCol2Html += `<h5 style="text-align:center;">${npcName}</h5>`;
        for(const stat in state.npcs[npcName]) {
            if(typeof state.npcs[npcName][stat] === 'number') {
                npcCol2Html += createCheatControlRow({
                    label: stat.charAt(0).toUpperCase() + stat.slice(1), value: state.npcs[npcName][stat],
                    neg_actions: [ {label: '-25', onclick:`cheatModifyNpcStat('${npcName}', '${stat}', -25)`}, {label: '-5', onclick:`cheatModifyNpcStat('${npcName}', '${stat}', -5)`}, {label: '-1', onclick:`cheatModifyNpcStat('${npcName}', '${stat}', -1)`} ],
                    pos_actions: [ {label: '+1', onclick:`cheatModifyNpcStat('${npcName}', '${stat}', 1)`}, {label: '+5', onclick:`cheatModifyNpcStat('${npcName}', '${stat}', 5)`}, {label: '+25', onclick:`cheatModifyNpcStat('${npcName}', '${stat}', 25)`} ]
                });
            }
        }
    });
    npcCol2Html += '</div>';
    npcsTab.innerHTML = npcsHtml + npcCol1Html + npcCol2Html + '</div>';

    showCheatTab('general');
}

/* optional money cheat – keeps two‑decimal precision */
function cheatMoney(delta){
  state.money = Math.round((state.money + delta) * 100) / 100;
  updateHeader();
}

/* toggle the hidden “Corruption” bar */
function toggleCorruptionDisplay(cb){
  state.showCorruption = cb.checked;
  updateNeedsUI();
}

/* --------------------------------------------------------------
   INITIALISATION
   -------------------------------------------------------------- */
document.getElementById('startBtn').addEventListener('click', () => {
  // Switch to the main game screen
  switchScreen('gameScreen');

  // Initialise dynamic values
  state.money = 0.00;
  updateHeader();          // date | time | money row
  updateNeedsUI();         // draw need bars (all green at start)

  // Build UI pieces that depend on JS
  initBottomButtons();    // hook up the bottom‑button bar
  buildCheatOverlay();    // populate the Cheats overlay

  // Show the first intro event
  showCurrentEvent();
});

</script>
</body>
</html>
