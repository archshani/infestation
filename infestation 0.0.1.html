<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Infestation</title>
<style>
/* -------------------------------------------------------------
   GLOBAL LAYOUT
------------------------------------------------------------- */
body{
  margin:0;
  font-family:Arial,Helvetica,sans-serif;
  background:#111;
  color:#eee;
  overflow:hidden;
}
.screen{display:none;height:100vh;box-sizing:border-box;}
.active{display:flex;}

/* -------------------------------------------------------------
   START SCREEN
------------------------------------------------------------- */
#startScreen{
  flex-direction:column;
  justify-content:center;
  align-items:center;
  background:linear-gradient(135deg,#220022,#001122);
}
#startScreen h1{font-size:3rem;margin-bottom:.5rem;}
#startScreen p{font-size:1.2rem;max-width:500px;text-align:center;}
#ascii-title{
  font-family:monospace;
  font-size:.5vw;
  line-height:.8;
  color:#00ff00;
  margin-bottom:1rem;
  text-shadow: 2px 2px 2px #000, 1px 1px 0px #f0f, -1px -1px 0px #0ff;
}
#startBtn, #loadBtn{
  margin-top:2rem;padding:.8rem 1.6rem;font-size:1.2rem;
  background:#00ff00;color:#000;border:none;cursor:pointer;
  border-radius:.4rem;
}
#startBtn:hover{background:#33ff33;}

/* -------------------------------------------------------------
   MAIN GAME SCREEN (sidebar + main area)
------------------------------------------------------------- */
#gameScreen{flex-direction:row;}

/* ----- Sidebar (always visible) ----- */
#sidebar{
  width:300px;
  background:#1a1a2d;
  padding:1rem;
  box-sizing:border-box;
  overflow-y:auto;
  position:relative;
}

/* ----- Header row (date | time | money) ----- */
#headerRow{
  display:flex;
  justify-content:space-between;
  font-size:.9rem;
  margin-bottom:1rem;
}
#headerRow span{
  flex:1;
  text-align:center;
}
#headerRow #date{text-align:left;}
#headerRow #money{text-align:right;}

/* ----- Character description ----- */
#charDesc{
  font-size:.85rem;
  margin-bottom:.8rem;
  color:#88ff88;
}

/* -------------------------------------------------
   NEED LAYOUT – thin full‑width bar, name & label on ONE line
   ------------------------------------------------- */

.need{
  margin-bottom:0.2rem;
  position:relative;
}

/* header that holds the combined “Name: Label” line */
.needHeader{
  display:flex;
  justify-content:center;
  margin-bottom:0.2rem;               /* space between text and bar */
}

/* the single line – we’ll fill it via JS */
.needLine{
  font-size:.85rem;
  color:#fff;                      /* name part is white */
}

/* the label part (after the colon) will be coloured by JS */
.needLine .stage{
  color:#ccc;                      /* fallback colour */
}

/* thin, sharp‑edge bar */
.bar{
  width:100%;
  height:6px;                      /* thin rectangle */
  background:#444;
  overflow:hidden;
}

/* coloured fill – colour set by JS */
.fill{
  height:100%;
  display:block;
}

/* -------------------------------------------------
   HIDDEN (“bad”) needs – show only the stage label
   ------------------------------------------------- */
.noName .needLine{
  /* show the line (previously hidden) */
  display:flex;               /* keep flex so the label aligns nicely */
  justify-content:center;
  margin-left:0.2rem;         /* tiny indent so it lines up with other lines */
}

/* the stage label inside a hidden need – colour will be set by JS */
.noName .needLine .stage{
  /* fallback colour – will be overridden */
  color:#aaa;
}

/* -------------------------------------------------
   TOOLTIP (shows name in white + % in bar colour)
   ------------------------------------------------- */
.tooltip{
  position:absolute;
  left:50%;
  bottom:120%;
  transform:translateX(-50%);
  padding:.3rem .5rem;
  background:#222;
  color:#fff;
  font-size:.75rem;
  white-space:nowrap;
  border-radius:3px;
  opacity:0;
  pointer-events:none;
  transition:opacity .15s ease;
  z-index:10;
}
.tooltip::after{
  content:"";
  position:absolute;
  top:100%;
  left:50%;
  transform:translateX(-50%);
  border-width:5px 5px 0 5px;
  border-style:solid;
  border-color:#222 transparent transparent transparent;
}
.need:hover .tooltip{
  opacity:1;
}

/* ---- Bottom button bar – each button on its own row, full width ---- */
#bottomButtons{
  display:flex;
  flex-direction:column;          /* stack vertically */
  gap:.4rem;
  position:absolute;
  bottom:1rem;
  width:calc(100% - 2rem);        /* parent padding is 1rem on each side */
}

/* generic button – fills the whole row */
.bottomBtn{
  flex:1 0 auto;                  /* take full width of its row */
  width:100%;
  padding:.4rem .6rem;
  box-sizing:border-box;

  /* NEW – visual styling */
  background:#444;                /* dark‑gray background (feel free to adjust) */
  color:#fff;                     /* white text for contrast */
  border:2px solid transparent;   /* invisible border so the button size doesn’t jump on hover */
  border-radius:4px;              /* optional rounded corners */
  transition:border-color .15s ease, background .15s ease; /* smooth hover effect */
}

/* Hover state – green border */
.bottomBtn:hover{
  background:#555;                /* a slightly lighter gray while hovered (optional) */
  border-color:#00ff00;           /* bright green border on hover */
}
/* -----------------------------------------------------------------
   OVERLAY BUTTON STYLE – independent from the global style
   ----------------------------------------------------------------- */
.overlayBtn{
  /* Reset anything that the global .bottomBtn forced */
  width:auto !important;          /* ignore the global width:100% */
  flex:0 1 auto;                  /* allow shrinking, no forced growth */
  display:inline-block;           /* size to its intrinsic content */
  padding:.35rem .6rem;           /* comfortable click/tap area */
  margin:0 .2rem;                 /* tiny gap between neighbour elements */
  min-width:0;                    /* clear any inherited min‑width */
  box-sizing:border-box;          /* include padding in the width */
}

/* OPTIONAL: give overlay buttons a distinct look (colour, hover, etc.) */
.overlayBtn{
  background:#222;                /* darker background than sidebar buttons */
  color:#00ff00;                  /* bright green text – matches the UI theme */
  border:1px solid #00ff00;
  border-radius:4px;
}
.overlayBtn:hover{
  background:#333;
}

/* ---- Settings / Cheats when cheats are enabled ---------------------- */
/* the body gets the class “cheats-enabled” when the checkbox is ticked */
body.cheats-enabled #bottomButtons{
  flex-direction:row;             /* switch to a horizontal row */
  flex-wrap:wrap;
}

/* each takes ≈½ of the line */
body.cheats-enabled .settingsBtn,
body.cheats-enabled .cheatsBtn{
  flex:1 1 48%;                   /* half‑width, leave a tiny gap */
  width:auto;                    /* let flex control width */
}

/* keep the Settings button left‑aligned, Cheats button on the right */
body.cheats-enabled .settingsBtn{margin-right:auto;}
body.cheats-enabled .cheatsBtn{margin-left:auto;}

/* -------------------------------------------------------------
   MAIN AREA (rooms / events)
------------------------------------------------------------- */
#mainArea{
  flex:1;
  position:relative;
  padding:1.5rem;
  overflow-y:auto;
}

/* Text styles */
.eventTitle{font-size:1.8rem;margin-top:0;color:#00ff00;}
.eventText{margin:1rem 0;line-height:1.4;}
.link{color:#00ff00;cursor:pointer;text-decoration:underline;}
.link:hover{color:#33ff33;}

/* -------------------------------------------------------------
   NAVIGATION COLUMN (absolute, anchored below text)
------------------------------------------------------------- */
.navColumn{
  position:absolute;
  left:15%;
  display:flex;
  flex-direction:column;
  gap:.6rem;
}
.navColumn .link{font-size:1.1rem;}

/* -------------------------------------------------------------
   OVERLAY WINDOWS (square, 30 % of viewport width)
------------------------------------------------------------- */
.overlay{
  position:fixed;
  top:50%; left:50%;
  transform:translate(-50%,-50%);
  background:#222;
  border:2px solid #00ff00;
  padding:1rem;
  width:65vw;
  height:45vw;
  max-width:80;
  max-height:80;
  z-index:1000;
  display:none;
}
.overlayHeader{
  font-weight:bold;
  margin-bottom:.6rem;
  color:#00ff00;
}
.overlayClose{
  position:absolute;
  top:.4rem;
  right:.6rem;
  cursor:pointer;
  color:#ff5555;
}
.overlayBody{margin-top:1.2rem;}

/* -------------------------------------------------------------
   BOTTOM BUTTON BAR – definitions (kept for reference)
------------------------------------------------------------- */
/* (the actual buttons are now written directly in the HTML) */

/* -------------------------------------------------------------
   RESPONSIVE ADJUSTMENTS (optional)
------------------------------------------------------------- */
@media (max-width:600px){
  #sidebar{width:100%;height:auto;}
  #gameScreen{flex-direction:column;}
}
</style>
</head>
<body>

<!-- ==================== START SCREEN ==================== -->
<section id="startScreen" class="screen active">
  <pre id="ascii-title">
░▒▓█▓▒░▒▓███████▓▒░░▒▓████████▓▒░▒▓████████▓▒░░▒▓███████▓▒░▒▓████████▓▒░▒▓██████▓▒░▒▓████████▓▒░▒▓█▓▒░░▒▓██████▓▒░░▒▓███████▓▒░
░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░      ░▒▓█▓▒░      ░▒▓█▓▒░         ░▒▓█▓▒░  ░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░   ░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░
░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░      ░▒▓█▓▒░      ░▒▓█▓▒░         ░▒▓█▓▒░  ░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░   ░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░
░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓██████▓▒░ ░▒▓██████▓▒░  ░▒▓██████▓▒░   ░▒▓█▓▒░  ░▒▓████████▓▒░ ░▒▓█▓▒░   ░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░
░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░      ░▒▓█▓▒░             ░▒▓█▓▒░  ░▒▓█▓▒░  ░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░   ░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░
░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░      ░▒▓█▓▒░             ░▒▓█▓▒░  ░▒▓█▓▒░  ░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░   ░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░
░▒▓█▓▒░▒▓█▓▒░░▒▓█▓▒░▒▓█▓▒░      ░▒▓████████▓▒░▒▓███████▓▒░   ░▒▓█▓▒░  ░▒▓█▓▒░░▒▓█▓▒░ ░▒▓█▓▒░   ░▒▓█▓▒░░▒▓██████▓▒░░▒▓█▓▒░░▒▓█▓▒░
  </pre>
  <p>
    Maya has been unlucky enough to become host to a worm‑like alien parasite.
    Manage her physical and mental state while she tries to uncover the truth.
  </p>
  <div id="start-buttons-container" style="display: flex; gap: 1rem;">
      <button id="startBtn">Begin</button>
      <button id="loadBtn">Load Game</button>
  </div>
</section>

<!-- ==================== LOAD OVERLAY (from Start Screen) ==================== -->
<div id="loadBtn-overlay" class="overlay">
  <div class="overlayHeader">Load Game</div>
  <div class="overlayClose" onclick="closeAllOverlays()">✖</div>
  <div class="overlayBody"></div>
</div>

<!-- ==================== MAIN GAME SCREEN ==================== -->
<section id="gameScreen" class="screen">
  <!-- ---------- Sidebar (always visible) ---------- -->
  <aside id="sidebar">
    <h3>Game Info</h3>

    <!-- Header row: Date | Time | Money -->
    <div id="headerRow">
      <span id="date">01 Aug 2025</span>
      <span id="clock">09:00</span>
      <span id="money">$0.00</span>
    </div>

    <!-- Character description -->
    <div id="charDesc">Wearing: lab coat, sneakers</div>

<!-- ==================== NEED CONTAINERS (NEW LAYOUT) ==================== -->

<!-- regular needs -->
<div class="need" id="need-tiredness"
     data-name="Fatigue"
     data-labels="Exhausted|Very Tired|Tired|Alert|Energized">
  <div class="needHeader">
    <span class="needLine"><!-- filled by JS --> </span>
  </div>
  <div class="bar"><span class="fill"></span></div>
  <div class="tooltip"></div>
</div>

<div class="need" id="need-stress"
     data-name="Stress"
     data-labels="Panicked|Very Stressed|Stressed|Calm|Relaxed">
  <div class="needHeader">
    <span class="needLine"></span>
  </div>
  <div class="bar"><span class="fill"></span></div>
  <div class="tooltip"></div>
</div>

<div class="need" id="need-trauma"
     data-name="Trauma"
     data-labels="Shattered|Severely Traumatized|Traumatized|Stable|Secure">
  <div class="needHeader">
    <span class="needLine"></span>
  </div>
  <div class="bar"><span class="fill"></span></div>
  <div class="tooltip"></div>
</div>

<div class="need" id="need-happiness"
     data-name="Happiness"
     data-labels="Depressed|Very Unhappy|Unhappy|Content|Joyful">
  <div class="needHeader">
    <span class="needLine"></span>
  </div>
  <div class="bar"><span class="fill"></span></div>
  <div class="tooltip"></div>
</div>

<div class="need" id="need-arousal"
     data-name="Arousal"
     data-labels="Numb|Very Low|Low|Normal|High">
  <div class="needHeader">
    <span class="needLine"></span>
  </div>
  <div class="bar"><span class="fill"></span></div>
  <div class="tooltip"></div>
</div>

<!-- hidden / “bad” needs – keep hidden until shown -->
<div class="need hiddenBar noName" id="need-corruption"
     data-name="Corruption"
     data-labels="None|Trace|Low|Medium|High">
  <div class="needHeader"><span class="needLine"></span></div>
  <div class="bar"><span class="fill"></span></div>
  <div class="tooltip"></div>
</div>

<div class="need hiddenBar noName" id="need-alcohol"
     data-name="Alcohol"
     data-labels="Sober|Buzzed|Tipsy|Drunk|Wasted">
  <div class="needHeader"><span class="needLine"></span></div>
  <div class="bar"><span class="fill"></span></div>
  <div class="tooltip"></div>
</div>

<div class="need hiddenBar noName" id="need-drugs"
     data-name="Drugs"
     data-labels="Clean|Mild|Moderate|Heavy|Overdose">
  <div class="needHeader"><span class="needLine"></span></div>
  <div class="bar"><span class="fill"></span></div>
  <div class="tooltip"></div>
</div>

    <!-- Bottom button bar (static HTML – JS will attach handlers) -->
    <div id="bottomButtons">
      <button id="btnChar"    class="bottomBtn">Character</button>
      <button id="btnSocial"  class="bottomBtn">Social</button>
      <button id="btnJournal" class="bottomBtn">Journal</button>
      <button id="btnSaves"   class="bottomBtn">Saves</button>

      <!-- Settings button – always visible -->
      <button id="btnSettings" class="bottomBtn settingsBtn">Settings</button>

      <!-- Cheats button – hidden until checkbox is ticked -->
      <button id="cheatsBtn"   class="bottomBtn cheatsBtn" style="display:none;">Cheats</button>
    </div>
  </aside>
<!-- CHARACTER overlay -->
<div id="btnChar-overlay" class="overlay">
  <div class="overlayHeader">Character</div>
  <div class="overlayClose" onclick="closeAllOverlays()">✖</div>
  <div class="overlayBody">
    <div id="char-buttons" style="display: flex; justify-content: space-between; margin-bottom: 1rem; gap: 0.5rem;">
        <button class="overlayBtn" style="flex-grow: 1;" onclick="showCharTab('status')">Status</button>
        <button class="overlayBtn" style="flex-grow: 1;" onclick="showCharTab('skills')">Skills</button>
        <button class="overlayBtn" style="flex-grow: 1;" onclick="showCharTab('stats')">Stats</button>
        <button class="overlayBtn" style="flex-grow: 1;" onclick="showCharTab('equipment')">Equipment</button>
        <button class="overlayBtn" style="flex-grow: 1;" onclick="showCharTab('inventory')">Inventory</button>
    </div>
    <div id="char-status" class="char-tab"></div>
    <div id="char-skills" class="char-tab" style="display: none;"></div>
    <div id="char-stats" class="char-tab" style="display: none;"></div>
    <div id="char-equipment" class="char-tab" style="display: none;"></div>
    <div id="char-inventory" class="char-tab" style="display: none;"></div>
  </div>
</div>


<!-- SOCIAL overlay -->
<div id="btnSocial-overlay" class="overlay">
  <div class="overlayHeader">Social</div>
  <div class="overlayClose" onclick="closeAllOverlays()">✖</div>
  <div class="overlayBody"></div>
</div>

<!-- JOURNAL overlay -->
<div id="btnJournal-overlay" class="overlay">
  <div class="overlayHeader">Journal</div>
  <div class="overlayClose" onclick="closeAllOverlays()">✖</div>
  <div class="overlayBody"></div>
</div>

<!-- SAVES overlay -->
<div id="btnSaves-overlay" class="overlay">
  <div class="overlayHeader">Saves</div>
  <div class="overlayClose" onclick="closeAllOverlays()">✖</div>
  <div class="overlayBody"></div>
</div>
  <!-- ---------- Main area (events / rooms) ---------- -->
  <main id="mainArea">
    <!-- Content will be injected by JavaScript -->
  </main>
</section>

<!-- SETTINGS overlay (square, 30 % of viewport width) -->
<div id="btnSettings-overlay" class="overlay settingsOverlay">
  <div class="overlayHeader">Settings</div>
  <div class="overlayClose" onclick="closeAllOverlays()">✖</div>
  <div class="overlayBody">
    <label style="display:flex;align-items:center;gap:.4rem;">
      <input type="checkbox" id="cheatsChk" onchange="toggleCheats(this)">
      Enable Cheats
    </label>
    <hr style="margin: 1rem 0;">
    <div style="margin-bottom: 1rem;">
      <strong>Font Family</strong>
      <div id="font-options" style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 0.5rem;">
        <label><input type="radio" name="font" value="Arial, Helvetica, sans-serif" onchange="changeFont(this.value)"> Arial</label>
        <label><input type="radio" name="font" value="'Times New Roman', Times, serif" onchange="changeFont(this.value)"> Times New Roman</label>
        <label><input type="radio" name="font" value="'Courier New', Courier, monospace" onchange="changeFont(this.value)"> Courier New</label>
        <label><input type="radio" name="font" value="Verdana, Geneva, sans-serif" onchange="changeFont(this.value)"> Verdana</label>
      </div>
    </div>
    <div>
      <strong>Font Size</strong>
      <div id="fontsize-options" style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 0.5rem;">
        <label><input type="radio" name="fontsize" value="0.9rem" onchange="changeFontSize(this.value)"> Small</label>
        <label><input type="radio" name="fontsize" value="1rem" onchange="changeFontSize(this.value)"> Medium</label>
        <label><input type="radio" name="fontsize" value="1.2rem" onchange="changeFontSize(this.value)"> Large</label>
      </div>
    </div>
  </div>
</div>

<!-- CHEATS overlay (same square size) -->
<div id="cheatsBtn-overlay" class="overlay cheatsOverlay">
  <div class="overlayHeader">Cheats</div>
  <div class="overlayClose" onclick="closeAllOverlays()">✖</div>
  <div class="overlayBody">
    <!-- Cheat controls will be inserted by JS later -->
  </div>
</div>

<!-- ==================== SUB-OVERLAY for item selection etc. ==================== -->
<div id="sub-overlay" class="overlay" style="width: 30vw; height: auto; max-height: 70vh;">
  <div class="overlayHeader"></div>
  <div class="overlayClose" onclick="document.getElementById('sub-overlay').style.display='none'">✖</div>
  <div class="overlayBody"></div>
</div>

<script>
/* ==============================================================
   CLASSES
   ============================================================== */
class BodyPart {
    constructor(id, name, adjectives = [], size = 'average') {
        this.id = id; // e.g., 'left_thigh'
        this.name = name; // e.g., 'Left Thigh'
        this.adjectives = adjectives; // e.g., ['strong', 'scarred']
        this.size = size;
        // Tattoos, piercings, etc. can be added here later
    }
}

class EquipmentSlot {
    constructor(id, name, layers = ['skin', 'middle', 'outer']) {
        this.id = id;
        this.name = name;
        layers.forEach(layer => {
            this[layer] = null;
        });
    }
}

class HandHeldSlot {
    constructor(name = 'Hand-held') {
        this.name = name;
        this.left = null;
        this.right = null;
    }
}

class BackSlot {
    constructor(name = 'Back') {
        this.name = name;
        this.item = null;
    }
}

class ClothingItem {
    constructor({
        id,
        name,
        slot, // The ID of the EquipmentSlot it goes into
        layer = null, // 'skin', 'middle', or 'outer'
        covers, // Array of BodyPart IDs it covers
        bonusStats = {}, // e.g., { warmth: 5, style: 10 }
        durability = 100,
        tags = []
    }) {
        this.id = id;
        this.name = name;
        this.slot = slot;
        this.layer = layer;
        this.covers = covers;
        this.bonusStats = bonusStats;
        this.durability = durability;
        this.tags = tags;
    }
}

/* ==============================================================
   FACTORIES
   ============================================================== */
function createPlayerBody(sex = 'female') {
    const body = {};
    const addPart = (id, name) => {
        body[id] = new BodyPart(id, name);
    };
    const addPairedParts = (baseId, baseName) => {
        addPart(`left_${baseId}`, `Left ${baseName}`);
        addPart(`right_${baseId}`, `Right ${baseName}`);
    };

    // Head & Face
    addPart('head', 'Head');
    addPart('neck', 'Neck');
    addPart('face', 'Face');
    addPart('forehead', 'Forehead');
    addPairedParts('eye', 'Eye');
    addPairedParts('ear', 'Ear');
    addPart('nose', 'Nose');
    addPart('tongue', 'Tongue');

    // Torso
    addPart('chest', 'Chest');
    addPart('belly', 'Belly');
    addPart('upper_back', 'Upper Back');
    addPart('lower_back', 'Lower Back');

    // Groin & Butt
    addPart('groin', 'Groin');
    addPart('butt', 'Buttocks');
    addPairedParts('ass_cheek', 'Ass Cheek');
    addPart('anus', 'Anus');

    // Limbs
    addPairedParts('arm', 'Arm');
    addPairedParts('hand', 'Hand');
    addPairedParts('thigh', 'Thigh');
    addPairedParts('calf', 'Calf');
    addPairedParts('foot', 'Foot');

    // Conditional parts based on sex
    if (sex === 'female') {
        addPairedParts('breast', 'Breast');
        addPart('vagina', 'Vagina');
    } else if (sex === 'male') {
        addPart('penis', 'Penis');
    }

    return body;
}


/* ==============================================================
   GLOBAL STATE
   ============================================================== */
const state = {
  /* -------------------- Time -------------------- */
  currentTime: new Date('2007-08-01T09:00:00'),   // start time (unchanged)

  /* -------------------- Money ------------------- */
  money: 0.00,

  /* -------------------- Intro events ------------ */
  eventIndex: 0,
  events: [
    {title:"Meet Maya",text:"Maya Alvarez, a marine biologist, woke up feeling a strange pressure in her abdomen. An alien worm‑like parasite has taken residence inside her, feeding off her nervous system."},
    {title:"Friend – Leah",text:"Leah Patel, Maya’s longtime friend, calls to check in. She senses something is off but Maya brushes it aside.", reveals: "Leah"},
    {title:"Friend – Amir",text:"Dr. Amir Khan, a neuro‑biology researcher, offers to run scans. He warns Maya about the risks of unknown pathogens.", reveals: "Amir"},
    {title:"Friend – Toby",text:"Toby, the lab’s tech specialist, jokes about “alien pets.” He hands Maya a bottle of energy drink.", reveals: "Toby"}
  ],

  /* -------------------- Needs ------------------- */
  needs: {
    tiredness: 10000,
    stress: 0,
    trauma: 0,
    happiness: 1000,
    arousal: 0,
    corruption: 0,
    alcohol: 0,
    drugs: 0
  },

  ranges: {
    tiredness: 10000,
    stress: 1000,
    trauma: 1000,
    happiness: 1000,
    arousal: 1000,
    corruption: 1000,
    alcohol: 100,
    drugs: 100
  },

  /* -------------------- Flags -------------------- */
  showCorruption: false,   // toggled from Cheats overlay
  cheatsEnabled: false,     // set by Settings → Enable Cheats
  storyEventActive: false, // disables stat-triggered events

  /* -------------------- Skills ------------------- */
  skills: {
    "PH skill 1": { level: 1, exp: 0 }, "PH skill 2": { level: 1, exp: 0 }, "PH skill 3": { level: 1, exp: 0 }, "PH skill 4": { level: 1, exp: 0 }, "PH skill 5": { level: 1, exp: 0 },
    "PH skill 6": { level: 1, exp: 0 }, "PH skill 7": { level: 1, exp: 0 }, "PH skill 8": { level: 1, exp: 0 }, "PH skill 9": { level: 1, exp: 0 }, "PH skill 10": { level: 1, exp: 0 },
    "PH skill 11": { level: 1, exp: 0 }, "PH skill 12": { level: 1, exp: 0 }, "PH skill 13": { level: 1, exp: 0 }, "PH skill 14": { level: 1, exp: 0 }, "PH skill 15": { level: 1, exp: 0 },
    "PH skill 16": { level: 1, exp: 0 }, "PH skill 17": { level: 1, exp: 0 }, "PH skill 18": { level: 1, exp: 0 }, "PH skill 19": { level: 1, exp: 0 }, "PH skill 20": { level: 1, exp: 0 },
    "PH skill 21": { level: 1, exp: 0 }, "PH skill 22": { level: 1, exp: 0 }, "PH skill 23": { level: 1, exp: 0 }, "PH skill 24": { level: 1, exp: 0 }, "PH skill 25": { level: 1, exp: 0 },
    "PH skill 26": { level: 1, exp: 0 }, "PH skill 27": { level: 1, exp: 0 }, "PH skill 28": { level: 1, exp: 0 }, "PH skill 29": { level: 1, exp: 0 }, "PH skill 30": { level: 1, exp: 0 },
    "PH skill 31": { level: 1, exp: 0 }, "PH skill 32": { level: 1, exp: 0 }, "PH skill 33": { level: 1, exp: 0 }, "PH skill 34": { level: 1, exp: 0 }, "PH skill 35": { level: 1, exp: 0 },
    "PH skill 36": { level: 1, exp: 0 }, "PH skill 37": { level: 1, exp: 0 }, "PH skill 38": { level: 1, exp: 0 }, "PH skill 39": { level: 1, exp: 0 }, "PH skill 40": { level: 1, exp: 0 },
    "PH skill 41": { level: 1, exp: 0 }, "PH skill 42": { level: 1, exp: 0 }, "PH skill 43": { level: 1, exp: 0 }, "PH skill 44": { level: 1, exp: 0 }, "PH skill 45": { level: 1, exp: 0 },
    "PH skill 46": { level: 1, exp: 0 }, "PH skill 47": { level: 1, exp: 0 }, "PH skill 48": { level: 1, exp: 0 }, "PH skill 49": { level: 1, exp: 0 }, "PH skill 50": { level: 1, exp: 0 }
  },

  /* -------------------- Character Physicality -------------------- */
  sex: 'female',
  playerBody: {}, // Will be populated by factory
  equipment: {
    head: new EquipmentSlot('head', 'Head'),
    neck: new EquipmentSlot('neck', 'Neck'),
    upper: new EquipmentSlot('upper', 'Upper Body'),
    lower: new EquipmentSlot('lower', 'Lower Body'),
    waist: new EquipmentSlot('waist', 'Waist'),
    arms: new EquipmentSlot('arms', 'Arms'),
    hands: new EquipmentSlot('hands', 'Hands'),
    legs: new EquipmentSlot('legs', 'Legs'),
    feet: new EquipmentSlot('feet', 'Feet'),
    'hand-held': new HandHeldSlot('Hand-held'),
    back: new BackSlot('Back')
  },
  inventory: [],

  /* -------------------- Stats -------------------- */
  stats: {
    timesSlept: 0,
    questsCompleted: 0,
    itemsCrafted: 0,
    distanceWalked: 0,
    timesCollapsedFromStress: 0,
    timesClimaxed: 0
  },

  /* -------------------- NPCs --------------------- */
  npcs: {
    "Leah": { relationship: 0, trust: 0, fear: 0, attraction: 0, hidden: true },
    "Amir": { relationship: 0, trust: 0, fear: 0, attraction: 0, hidden: true },
    "Toby": { relationship: 0, trust: 0, fear: 0, attraction: 0, hidden: true }
  },

  /* -------------------- Journal ------------------ */
  journal: {
    quests: [
      { title: "Uncover the Truth", description: "Find out more about the alien parasite and its origins.", complete: false },
      { title: "Get some rest", description: "You were feeling exhausted, but you took a nap.", complete: true }
    ],
    reminders: ["Appointment with Dr. Amir next Tuesday at 2pm."],
    notes: "I can write my own notes here."
  },

  settings: {
    fontFamily: 'Arial, Helvetica, sans-serif',
    fontSize: '1rem'
  },

  /* -------------------- Game Location ------------------ */
  currentLocation: 'event_intro',
  locationBeforeEvent: '',

  scenes: {
    'foyer': {
      title: 'Laboratory Foyer',
      description: 'The foyer is dimly lit, metal doors line the walls, and a low hum of equipment reverberates through the concrete floor. A faint smell of antiseptic hangs in the air.',
      nav: [
        { text: 'Kitchen', action: "goToScene('kitchen', 30)" },
        { text: 'Lounge', action: "goToScene('lounge', 30)" },
        { text: 'Bathroom', action: "goToScene('bathroom', 30)" },
        { text: 'Visit the Tailor', action: "goToTailorHub()" },
        {
          text: 'Check in with Leah',
          action: "goToScene('leah_love_event', 0)",
          condition: { type: 'npc_relationship', npc: 'Leah', operator: '>=', value: 50 }
        },
        {
          text: 'Check in with Amir',
          action: "goToScene('amir_love_event', 0)",
          condition: { type: 'npc_relationship', npc: 'Amir', operator: '>=', value: 50 }
        },
        {
          text: 'Check in with Toby',
          action: "goToScene('toby_love_event', 0)",
          condition: { type: 'npc_relationship', npc: 'Toby', operator: '>=', value: 50 }
        }
      ],
      randomEvents: [
        { chance: 0.2, scene: 'random_foyer_1' }
      ]
    },
    'kitchen': {
      title: 'Kitchen',
      description: 'Stainless steel counters glint under harsh fluorescent lights. A coffee maker gurgles, and a half-eaten sandwich rests on a plate. The scent of stale coffee lingers. The fridge hums softly, casting a faint blue glow across the tiled floor.',
      nav: [
        { text: 'Back to Foyer', action: "goToScene('foyer', 30)" }
      ],
      randomEvents: [
        { chance: 0.2, scene: 'random_kitchen_1' }
      ]
    },
    'lounge': {
      title: 'Lounge',
      description: 'Plush chairs face a wall-mounted screen playing calming nature footage. Shelves hold scientific journals and a few well-worn novels. Soft ambient music drifts.',
      nav: [
        { text: 'Back to Foyer', action: "goToScene('foyer', 30)" },
        { text: 'Relax', action: "goToScene('relaxing', 0)" }
      ],
      randomEvents: [
        { chance: 0.2, scene: 'random_lounge_1' }
      ]
    },
    'bathroom': {
      title: 'Bathroom',
      description: 'White tiles line the walls, a single sink flickers with a weak bulb. The mirror fogs slightly as warm air circulates. A small cabinet holds basic toiletries.',
      nav: [
        { text: 'Back to Foyer', action: "goToScene('foyer', 30)" },
        { text: 'Take a shower', action: "goToScene('showering', 0)" }
      ],
      randomEvents: [
        { chance: 0.2, scene: 'random_bathroom_1' }
      ]
    },
    'showering': {
      title: 'Shower',
      description: 'You undress and take a shower.',
      nav: [
        { text: 'Finish', action: "finishShower()" }
      ]
    },
    'relaxing': {
      title: 'Relaxing',
      description: 'You sit back and relax for a while.',
      nav: [
        { text: 'Finish', action: "finishRelaxing()" }
      ]
    },
    'random_foyer_1': {
      title: 'A Glimmer',
      description: 'You notice a strange glimmer near the air vent, but it vanishes as you approach.',
      nav: [
        { text: 'Continue', action: "goToScene('foyer', 0)" }
      ]
    },
    'random_kitchen_1': {
      title: 'A Strange Smell',
      description: 'A strange, sickly sweet smell emanates from the drain. You make a mental note to get it checked out.',
      nav: [
        { text: 'Continue', action: "goToScene('kitchen', 0)" }
      ]
    },
    'random_lounge_1': {
      title: 'A Flicker on the Screen',
      description: 'For a brief moment, the calming nature footage on the screen is replaced by a flash of static and what looks like alien text.',
      nav: [
        { text: 'Continue', action: "goToScene('lounge', 0)" }
      ]
    },
    'random_bathroom_1': {
      title: 'A Puddle',
      description: 'You notice a small, iridescent puddle forming under the sink, but it evaporates before you can get a closer look.',
      nav: [
        { text: 'Continue', action: "goToScene('bathroom', 0)" }
      ]
    },
    'leah_love_event': {
      title: 'A Moment with Leah',
      description: 'Placeholder text for a special moment with Leah.',
      nav: [
        { text: 'Return to Foyer', action: "goToScene('foyer', 0)" }
      ]
    },
'tailor_hub': {
    title: 'The Tailor',
    description: 'The tailor is a mysterious figure who can create any clothing you desire, for a price. What would you like to create?',
    nav: [] // This will be populated dynamically
},
    'amir_love_event': {
      title: 'A Moment with Amir',
      description: 'Placeholder text for a special moment with Amir.',
      nav: [
        { text: 'Return to Foyer', action: "goToScene('foyer', 0)" }
      ]
    },
    'toby_love_event': {
      title: 'A Moment with Toby',
      description: 'Placeholder text for a special moment with Toby.',
      nav: [
        { text: 'Return to Foyer', action: "goToScene('foyer', 0)" }
      ]
    },
    'stress_collapse_event': {
      title: 'Overwhelmed',
      description: 'The weight of everything becomes too much. The world spins and fades to black as you collapse from the stress.',
      nav: [
        { text: 'Wake up later...', action: "recoverFromStressCollapse()" }
      ]
    },
    'arousal_max_event': {
      title: 'Overcome',
      description: 'A wave of intense pleasure washes over you, so powerful it leaves you breathless and trembling on the floor.',
      nav: [
        { text: 'Recover...', action: "recoverFromArousalMax()" }
      ]
    }
  }
};

/* ==============================================================
   CLOTHING TEMPLATES
   ============================================================== */
const clothingTemplates = {
  // Head
  hat_baseball_cap: { id: 'hat_baseball_cap', name: 'Baseball Cap', slot: 'head', layer: 'outer', covers: ['head'], tags: ['dummy'] },
  hat_beanie: { id: 'hat_beanie', name: 'Beanie', slot: 'head', layer: 'outer', covers: ['head'], tags: ['dummy'] },
  glasses_sunglasses: { id: 'glasses_sunglasses', name: 'Sunglasses', slot: 'head', layer: 'outer', covers: ['face'], tags: ['dummy'] },
  // Upper Body
  upper_tshirt: { id: 'upper_tshirt', name: 'Plain T-Shirt', slot: 'upper', layer: 'middle', covers: ['chest', 'belly', 'upper_back'], tags: ['dummy'] },
  upper_shirt_buttondown: { id: 'upper_shirt_buttondown', name: 'Button-down Shirt', slot: 'upper', layer: 'middle', covers: ['chest', 'belly', 'upper_back', 'lower_back', 'left_arm', 'right_arm'], tags: ['dummy'] },
  upper_sweater: { id: 'upper_sweater', name: 'Sweater', slot: 'upper', layer: 'middle', covers: ['chest', 'belly', 'upper_back', 'lower_back', 'left_arm', 'right_arm'], tags: ['dummy'] },
  upper_hoodie: { id: 'upper_hoodie', name: 'Hoodie', slot: 'upper', layer: 'outer', covers: ['chest', 'belly', 'upper_back', 'lower_back', 'left_arm', 'right_arm', 'head'], tags: ['dummy'] },
  upper_jacket_leather: { id: 'upper_jacket_leather', name: 'Leather Jacket', slot: 'upper', layer: 'outer', covers: ['chest', 'belly', 'upper_back', 'lower_back', 'left_arm', 'right_arm'], tags: ['dummy'] },
  upper_coat_trench: { id: 'upper_coat_trench', name: 'Trench Coat', slot: 'upper', layer: 'outer', covers: ['chest', 'belly', 'upper_back', 'lower_back', 'left_arm', 'right_arm', 'left_thigh', 'right_thigh'], tags: ['dummy'] },
  upper_bra: { id: 'upper_bra', name: 'Plain Bra', slot: 'upper', layer: 'skin', covers: ['chest'], tags: ['underwear', 'upper_underwear'] },
  // Lower Body
  lower_jeans: { id: 'lower_jeans', name: 'Plain Jeans', slot: 'lower', layer: 'middle', covers: ['left_thigh', 'right_thigh', 'left_calf', 'right_calf', 'groin', 'butt'], tags: ['dummy'] },
  lower_shorts_denim: { id: 'lower_shorts_denim', name: 'Denim Shorts', slot: 'lower', layer: 'middle', covers: ['groin', 'butt', 'left_thigh', 'right_thigh'], tags: ['dummy'] },
  lower_skirt_short: { id: 'lower_skirt_short', name: 'Short Skirt', slot: 'lower', layer: 'middle', covers: ['groin', 'butt', 'left_thigh', 'right_thigh'], tags: ['dummy'] },
  lower_panties: { id: 'lower_panties', name: 'Plain Panties', slot: 'lower', layer: 'skin', covers: ['groin', 'butt'], tags: ['underwear', 'lower_underwear'] },
  // Feet
  feet_sneakers: { id: 'feet_sneakers', name: 'Plain Sneakers', slot: 'feet', layer: 'outer', covers: ['left_foot', 'right_foot'], tags: ['dummy'] },
  feet_boots_combat: { id: 'feet_boots_combat', name: 'Combat Boots', slot: 'feet', layer: 'outer', covers: ['left_foot', 'right_foot', 'left_calf', 'right_calf'], tags: ['dummy'] },
  // Back
  back_backpack: { id: 'back_backpack', name: 'Backpack', slot: 'back', covers: [], tags: ['dummy'] },
  // Hand-held
  handheld_handbag: { id: 'handheld_handbag', name: 'Handbag', slot: 'hand-held', covers: [], tags: ['dummy'] }
};

/* ==============================================================
   CLOTHING HELPERS
   ============================================================== */
function updateCharDesc() {
    const descEl = document.getElementById('charDesc');
    
    // --- 1. Data Gathering ---
    const allEquippedItems = [];
    const underwearItems = [];
    const outerwearItems = new Map();

    for (const slotId in state.equipment) {
        const slot = state.equipment[slotId];
        let outermostItem = null;

        if (slot instanceof EquipmentSlot) {
            outermostItem = slot.outer || slot.middle || slot.skin;
            if (slot.skin && slot.skin.tags.includes('underwear')) {
                underwearItems.push(slot.skin);
            }
        } else if (slot instanceof BackSlot) {
            outermostItem = slot.item;
        } else if (slot instanceof HandHeldSlot) {
            if(slot.left) allEquippedItems.push(slot.left);
            if(slot.right) allEquippedItems.push(slot.right);
        }
        
        if (outermostItem) {
            outerwearItems.set(slotId, outermostItem);
        }
    }
    
    // Add handheld items to the final list
    allEquippedItems.push(...Array.from(outerwearItems.values()));

    const coveredParts = getCoveredBodyParts();
    const vaginaExposed = !coveredParts.has('vagina');
    const breastsExposed = !coveredParts.has('left_breast') && !coveredParts.has('right_breast');
    
    const hasBra = underwearItems.some(i => i.tags.includes('upper_underwear'));
    const hasPanties = underwearItems.some(i => i.tags.includes('lower_underwear'));
    const isWearingOuterwear = Array.from(outerwearItems.values()).some(i => !i.tags.includes('underwear'));

    // --- 2. Handle exposure states ---
    if (vaginaExposed && breastsExposed) {
        descEl.innerHTML = '<span style="color: #880000;">You are completely naked!</span>';
        return;
    }

    // --- 3. Handle underwear-only states ---
    if (!isWearingOuterwear && (hasBra || hasPanties)) {
        let desc = '';
        if (hasBra && !hasPanties) {
            const bra = underwearItems.find(i => i.tags.includes('upper_underwear'));
            desc = `You are wearing your ${bra.name}, but you are not wearing any panties.`;
        } else if (!hasBra && hasPanties) {
            const panties = underwearItems.find(i => i.tags.includes('lower_underwear'));
            desc = `You are wearing your ${panties.name}, but you are not wearing any bra.`;
        } else { // hasBra && hasPanties
            const bra = underwearItems.find(i => i.tags.includes('upper_underwear'));
            const panties = underwearItems.find(i => i.tags.includes('lower_underwear'));
            desc = `You are wearing your ${bra.name} and ${panties.name}.`;
        }
        descEl.innerHTML = desc;
        return;
    }

    // --- 4. Default clothing description ---
    let description = 'Wearing: ';
    const outerwearNames = Array.from(outerwearItems.values()).map(item => item.name);
    description += outerwearNames.join(', ');

    let exposureMessage = '';
    if (breastsExposed) {
        exposureMessage = '<span style="color: #880000;">Your breasts are exposed!</span>';
    } else if (vaginaExposed) {
        exposureMessage = '<span style="color: #880000;">Your vagina is exposed!</span>';
    }

    // Only add "beneath" text if not exposed
    if (!exposureMessage) {
        if (underwearItems.length > 0) {
            const underwearNames = underwearItems.map(item => item.name);
            description += ` with ${underwearNames.join(' and ')} beneath.`;
        } else if (isWearingOuterwear) {
            description += ' with <span style="color: purple;">nothing beneath</span>.';
        }
    }

    if (exposureMessage) {
        description += `<br>${exposureMessage}`;
    }

    descEl.innerHTML = description;
}


function equipItem(itemId, subSlot) { // subSlot can be layer, hand, or null for 'back'
    const itemIndex = state.inventory.findIndex(i => i.id === itemId);
    if (itemIndex === -1) { console.error(`Item "${itemId}" not found.`); return; }

    const item = state.inventory[itemIndex];
    const targetSlotId = item.slot;
    const slot = state.equipment[targetSlotId];

    if (!slot) { console.error(`Slot "${targetSlotId}" not found.`); return; }

    // Determine what's currently equipped in the target location
    let currentlyEquippedItem = null;
    if (slot instanceof BackSlot) {
        currentlyEquippedItem = slot.item;
    } else if (slot instanceof HandHeldSlot && slot.hasOwnProperty(subSlot)) {
        currentlyEquippedItem = slot[subSlot];
    } else if (slot instanceof EquipmentSlot && slot.hasOwnProperty(subSlot)) {
        currentlyEquippedItem = slot[subSlot];
    }

    // If an item is there, move it to inventory
    if (currentlyEquippedItem) {
        state.inventory.push(currentlyEquippedItem);
    }

    // Equip the new item
    if (slot instanceof BackSlot) {
        slot.item = item;
    } else if (slot instanceof HandHeldSlot && slot.hasOwnProperty(subSlot)) {
        slot[subSlot] = item; // 'left' or 'right'
    } else if (slot instanceof EquipmentSlot && slot.hasOwnProperty(subSlot)) {
        slot[subSlot] = item; // 'skin', 'middle', 'outer'
    } else {
        console.error(`Cannot equip to invalid slot type for ${targetSlotId}`);
        if (currentlyEquippedItem) { state.inventory.pop(); } // Revert if equip fails
        return;
    }

    // Remove the newly equipped item from inventory
    state.inventory.splice(itemIndex, 1);
    // Sort inventory alphabetically for consistency, useful for UI
    state.inventory.sort((a, b) => a.name.localeCompare(b.name));
}

function unequipItem(slotId, subSlot) { // subSlot is layer, hand, or null
    const slot = state.equipment[slotId];
    if (!slot) { console.error(`Slot "${slotId}" not found.`); return; }

    let itemToUnequip = null;

    if (slot instanceof BackSlot) {
        itemToUnequip = slot.item;
        slot.item = null;
    } else if (slot instanceof HandHeldSlot && slot.hasOwnProperty(subSlot)) {
        itemToUnequip = slot[subSlot];
        slot[subSlot] = null;
    } else if (slot instanceof EquipmentSlot && slot.hasOwnProperty(subSlot)) {
        itemToUnequip = slot[subSlot];
        slot[subSlot] = null;
    }

    if (itemToUnequip) {
        state.inventory.push(itemToUnequip);
        // Sort inventory alphabetically for consistency
        state.inventory.sort((a, b) => a.name.localeCompare(b.name));
    } else {
        console.log(`Nothing to unequip from ${slotId} -> ${subSlot}`);
    }

    // Refresh UI
    buildEquipmentTab();
    updateCharDesc();
}

function getCoveredBodyParts() {
    const coveredParts = new Set();

    // Helper to add item's coverage to the set
    const addItemCoverage = (item) => {
        if (item && item.covers) {
            item.covers.forEach(partId => coveredParts.add(partId));
        }
    };

    // Iterate over all equipment slots
    for (const slotId in state.equipment) {
        const slot = state.equipment[slotId];
        if (slot instanceof EquipmentSlot) {
            // Layered slots
            addItemCoverage(slot.skin);
            addItemCoverage(slot.middle);
            addItemCoverage(slot.outer);
        } else if (slot instanceof HandHeldSlot) {
            // Hand-held slots
            addItemCoverage(slot.left);
            addItemCoverage(slot.right);
        } else if (slot instanceof BackSlot) {
            // Back slot
            addItemCoverage(slot.item);
        }
    }

    // Apply special coverage rules
    if (coveredParts.has('groin')) {
        coveredParts.add('vagina');
        coveredParts.add('anus');
    }
    if (coveredParts.has('chest')) {
        coveredParts.add('left_breast');
        coveredParts.add('right_breast');
    }

    return coveredParts;
}

/* ==============================================================
   UTILS
   ============================================================== */
function fmtHM(d){ return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',hour12:false}); }
function fmtDate(d){ return d.toLocaleDateString(); }

function formatMoney(amount) {
    if (amount >= 10000000) {
        return `$${(amount / 1000000).toFixed(0)}M`;
    } else if (amount >= 10000) {
        return `$${(amount / 1000).toFixed(0)}k`;
    } else if (amount >= 1000) {
        return `$${amount.toFixed(0)}`;
    } else {
        return `$${amount.toFixed(2)}`;
    }
}

function applySettings() {
  const settings = state.settings;
  document.body.style.fontFamily = settings.fontFamily;
  document.body.style.fontSize = settings.fontSize;
}

function changeFont(font) {
  state.settings.fontFamily = font;
  applySettings();
}

function changeFontSize(size) {
  state.settings.fontSize = size;
  applySettings();
}

function forceGlobalUIRefresh() {
  updateHeader();
  updateNeedsUI();
}

function checkStatTriggers() {
  if (state.storyEventActive) {
    return; // Don't interrupt story events
  }

  // Check for Stress max-out
  if (state.needs.stress >= state.ranges.stress) {
    state.locationBeforeEvent = state.currentLocation;
    goToScene('stress_collapse_event', 0);
  }

  // Check for Arousal max-out
  if (state.needs.arousal >= state.ranges.arousal) {
    state.locationBeforeEvent = state.currentLocation;
    goToScene('arousal_max_event', 0);
  }
}

/* Advance time by a given number of seconds and refresh the header */
function advanceTime(seconds, updateUI = true) {
  if (typeof seconds !== 'number' || seconds < 0) return;

  const needs = state.needs;
  const ranges = state.ranges;

  // --- CALCULATE DECREASES ---

  // Fatigue (tiredness) decreases over time. 10000 points over 24 hours (86400s)
  const fatigueDecrease = seconds * (10000 / 86400);
  needs.tiredness = Math.max(0, needs.tiredness - fatigueDecrease);

  // Stress recovers over time: 1 point every 30 seconds
  const stressDecrease = seconds * (1 / 30);
  needs.stress = Math.max(0, needs.stress - stressDecrease);

  // Trauma recovers very slowly: 1 point every hour (3600s)
  const traumaDecrease = seconds * (1 / 3600);
  needs.trauma = Math.max(0, needs.trauma - traumaDecrease);

  // Alcohol metabolizes: 12 points every hour (3600s)
  const alcoholDecrease = seconds * (12 / 3600);
  needs.alcohol = Math.max(0, needs.alcohol - alcoholDecrease);

  // Drugs wear off: 6 points every hour (3600s)
  const drugsDecrease = seconds * (6 / 3600);
  needs.drugs = Math.max(0, needs.drugs - drugsDecrease);

  // Arousal has two-tier decay
  const arousal50PctMark = ranges.arousal / 2;
  if (needs.arousal >= arousal50PctMark) {
    // Rate for >=50%: 500 points over 10 mins (600s)
    const arousalDecrease = seconds * (500 / 600);
    needs.arousal = Math.max(arousal50PctMark, needs.arousal - arousalDecrease);
  } else {
    // Rate for <50%: 500 points over 5 mins (300s)
    const arousalDecrease = seconds * (500 / 300);
    needs.arousal = Math.max(0, needs.arousal - arousalDecrease);
  }

  state.currentTime = new Date(state.currentTime.getTime() + (seconds * 1000));
  if (updateUI) {
    forceGlobalUIRefresh();
  }
  checkStatTriggers();
}

/* ==============================================================
   JOURNAL
   ============================================================== */
function buildJournalOverlay() {
    const body = document.querySelector('#btnJournal-overlay .overlayBody');
    if (!body) return;

    // Make body scrollable
    body.style.height = 'calc(100% - 3rem)';
    body.style.overflowY = 'auto';

    // --- Active Quests ---
    let activeQuestsHtml = '<ul>';
    const activeQuests = state.journal.quests.filter(q => !q.complete);
    if (activeQuests.length > 0) {
        activeQuests.forEach(q => {
            activeQuestsHtml += `<li><strong>${q.title}:</strong> ${q.description}</li>`;
        });
    } else {
        activeQuestsHtml += '<li>No active quests.</li>';
    }
    activeQuestsHtml += '</ul>';

    // --- Completed Quests ---
    let completedQuestsHtml = '<ul>';
    const completedQuests = state.journal.quests.filter(q => q.complete);
    if (completedQuests.length > 0) {
        completedQuests.forEach(q => {
            completedQuestsHtml += `<li><s><strong>${q.title}:</strong> ${q.description}</s></li>`;
        });
    } else {
        completedQuestsHtml += '<li>No completed quests yet.</li>';
    }
    completedQuestsHtml += '</ul>';

    // --- Reminders ---
    let remindersHtml = '<ul>';
    if (state.journal.reminders.length > 0) {
        state.journal.reminders.forEach(r => {
            remindersHtml += `<li>${r}</li>`;
        });
    } else {
        remindersHtml += '<li>No reminders.</li>';
    }
    remindersHtml += '</ul>';

    body.innerHTML = `
        <div>
            <h4>Active Quests</h4>
            ${activeQuestsHtml}
        </div>
        <div style="margin-top: 1rem;">
            <h4>Completed Quests</h4>
            ${completedQuestsHtml}
        </div>
        <div style="margin-top: 1rem;">
            <h4>Reminders</h4>
            ${remindersHtml}
        </div>
        <div style="margin-top: 1rem;">
            <h4>Notes</h4>
            <textarea id="journal-notepad" rows="20" style="width: 100%; background: #111; color: #eee; border: 1px solid #444;"></textarea>
        </div>
    `;

    const notepad = document.getElementById('journal-notepad');
    notepad.value = state.journal.notes;
    notepad.addEventListener('input', (event) => {
        state.journal.notes = event.target.value;
    });
}

/* ==============================================================
   SAVES
   ============================================================== */
function isSaveDataValid(saveData) {
    if (!saveData || typeof saveData !== 'object') return false;
    if (!saveData.state || typeof saveData.state !== 'object') return false;

    const s = saveData.state;
    const requiredKeys = ['currentTime', 'money', 'needs', 'skills', 'npcs', 'journal', 'currentLocation', 'scenes'];
    for (const key of requiredKeys) {
        if (!(key in s)) {
            console.error(`Save data validation failed: Missing key "${key}"`);
            return false;
        }
    }
    return true;
}

function buildLoadScreen() {
    const body = document.querySelector('#loadBtn-overlay .overlayBody');
    if (!body) return;

    let slotsHtml = '';
    for (let i = 1; i <= 10; i++) {
        const saveKey = `infestation_save_${i}`;
        const savedData = localStorage.getItem(saveKey);
        let slotName = "Empty Slot";
        let slotDate = "";

        if (savedData) {
            const data = JSON.parse(savedData);
            slotName = data.name;
            slotDate = new Date(data.date).toLocaleString();
        }

        slotsHtml += `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-bottom: 1px solid #444;">
                <div style="flex-grow: 1;">
                    <span style="font-weight: bold;">${i}: ${slotName}</span>
                    <span style="font-size: 0.8em; color: #aaa; margin-left: 1rem;">${slotDate}</span>
                </div>
                <div>
                    <button class="overlayBtn" disabled>Save</button>
                    <button class="overlayBtn" onclick="loadGame(${i})" ${!savedData ? 'disabled' : ''}>Load</button>
                    <button class="overlayBtn" disabled>Export</button>
                </div>
            </div>
        `;
    }

    body.innerHTML = `
        <div style="height: 100%; display: flex; flex-direction: column;">
            <div style="flex-grow: 1; overflow-y: auto;">${slotsHtml}</div>
            <div style="padding-top: 1rem; text-align: right;">
                <button class="overlayBtn" onclick="importGame()">Import</button>
            </div>
        </div>
    `;
}

function buildSavesOverlay() {
    const body = document.querySelector('#btnSaves-overlay .overlayBody');
    if (!body) return;

    let slotsHtml = '';
    for (let i = 1; i <= 10; i++) {
        const saveKey = `infestation_save_${i}`;
        const savedData = localStorage.getItem(saveKey);
        let slotName = "Empty Slot";
        let slotDate = "";

        if (savedData) {
            const data = JSON.parse(savedData);
            slotName = data.name;
            slotDate = new Date(data.date).toLocaleString();
        }

        slotsHtml += `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-bottom: 1px solid #444;">
                <div style="flex-grow: 1;">
                    <span style="font-weight: bold;">${i}: ${slotName}</span>
                    <span style="font-size: 0.8em; color: #aaa; margin-left: 1rem;">${slotDate}</span>
                </div>
                <div>
                    <button class="overlayBtn" onclick="saveGame(${i})">Save</button>
                    <button class="overlayBtn" onclick="loadGame(${i})" ${!savedData ? 'disabled' : ''}>Load</button>
                    <button class="overlayBtn" onclick="exportGame(${i})" ${!savedData ? 'disabled' : ''}>Export</button>
                </div>
            </div>
        `;
    }

    body.innerHTML = `
        <div style="height: 100%; display: flex; flex-direction: column;">
            <div style="flex-grow: 1; overflow-y: auto;">${slotsHtml}</div>
            <div style="padding-top: 1rem; text-align: right;">
                <button class="overlayBtn" onclick="importGame()">Import</button>
            </div>
        </div>
    `;
}

function saveGame(slotId) {
    const saveName = prompt("Enter a name for your save:", `Save Slot ${slotId}`);
    if (!saveName) return; // User cancelled

    const saveData = {
        name: saveName,
        date: new Date().toISOString(),
        state: state
    };

    try {
        localStorage.setItem(`infestation_save_${slotId}`, JSON.stringify(saveData));
        buildSavesOverlay(); // Refresh the saves screen
    } catch (e) {
        alert("Error saving game: Your browser's storage might be full.");
        console.error("Save failed: ", e);
    }
}

function loadState(newState) {
    try {
        // A simple deep copy for the main state properties
        Object.keys(newState).forEach(key => {
            if (key === 'currentTime') {
                state.currentTime = new Date(newState.currentTime);
            } else {
                state[key] = newState[key];
            }
        });

        switchScreen('gameScreen');
        fullUiRefresh();
        closeAllOverlays();
    } catch (e) {
        alert("Error loading game state: The save data may be corrupt.");
        console.error("Load failed: ", e);
    }
}

function loadGame(slotId) {
    const saveDataString = localStorage.getItem(`infestation_save_${slotId}`);
    if (!saveDataString) {
        alert("No save data found in this slot.");
        return;
    }

    try {
        const saveData = JSON.parse(saveDataString);
        if (!isSaveDataValid(saveData)) {
            throw new Error("Save data is corrupted or invalid.");
        }
        loadState(saveData.state);
    } catch (e) {
        alert(`Error loading game: ${e.message}`);
        console.error("Load failed: ", e);
    }
}

function exportGame(slotId) {
    const saveDataString = localStorage.getItem(`infestation_save_${slotId}`);
    if (!saveDataString) {
        alert("No save data in this slot to export.");
        return;
    }

    const blob = new Blob([saveDataString], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `infestation_save_${slotId}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function importGame() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.txt,application/json';

    input.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(event) {
            const saveDataString = event.target.result;
            try {
                const saveData = JSON.parse(saveDataString);
                if (!isSaveDataValid(saveData)) {
                    throw new Error("Imported file is not a valid save file.");
                }
                loadState(saveData.state);
            } catch (err) {
                alert(`Failed to import save data: ${err.message}`);
                console.error("Import failed: ", err);
            }
        };
        reader.readAsText(file);
    };

    input.click();
}

function fullUiRefresh() {
    updateHeader();
    updateNeedsUI();
    initBottomButtons();
    applySettings();
    applyCheatsUI();

    // Re-render the main area based on current location
    if (state.currentLocation === 'event_intro') {
        showCurrentEvent();
    } else {
        renderScene(state.currentLocation);
    }
}

/* ==============================================================
   SKILL SYSTEM UTILS
   ============================================================== */
function getExpForLevel(level) {
  if (level >= 20) return Infinity;
  return 8 * Math.pow(2, level - 1);
}

function addSkillExp(skillName, amount) {
  const skill = state.skills[skillName];
  if (!skill) return;

  // At level 20, you can't gain more exp, but you can lose it.
  if (skill.level >= 20 && amount > 0) {
    skill.exp = getExpForLevel(19); // Ensure it's capped
    return;
  }

  skill.exp += amount;

  // Handle level ups
  let expToLevelUp = getExpForLevel(skill.level);
  while (skill.level < 20 && skill.exp >= expToLevelUp) {
    skill.level++;
    skill.exp -= expToLevelUp;
    expToLevelUp = getExpForLevel(skill.level);
  }

  // Handle level downs
  while (skill.exp < 0) {
    if (skill.level <= 1) {
      skill.exp = 0;
      break;
    }
    skill.level--;
    const expFromPreviousLevel = getExpForLevel(skill.level);
    skill.exp += expFromPreviousLevel;
  }

  // Final check to cap at level 20
  if (skill.level >= 20) {
    skill.level = 20;
    skill.exp = getExpForLevel(19);
  }
}

/* ==============================================================
   CHARACTER WINDOW
   ============================================================== */
function showCharTab(tabName) {
    document.querySelectorAll('.char-tab').forEach(t => t.style.display = 'none');
    const tab = document.getElementById(`char-${tabName}`);
    if (tab) tab.style.display = 'block';
    
    if (tabName === 'status') updateCharStatusTab();
    else if (tabName === 'skills') updateCharSkillsTab();
    else if (tabName === 'stats') updateCharStatsTab();
    else if (tabName === 'equipment') buildEquipmentTab();
    else if (tabName === 'inventory') buildInventoryTab();
}

function openItemSelectionOverlay(slotId, subSlot = null) {
    const subOverlay = document.getElementById('sub-overlay');
    const header = subOverlay.querySelector('.overlayHeader');
    const body = subOverlay.querySelector('.overlayBody');

    // Logic change: filter by slot only, not layer.
    const compatibleItems = state.inventory.filter(item => item.slot === slotId);

    let headerText;
    const slot = state.equipment[slotId];
    const slotName = slot ? slot.name : slotId;

    if (slot instanceof EquipmentSlot) { // Layered slots
        headerText = `Select Item for ${slotName} (${subSlot} layer)`;
    } else if (slot instanceof HandHeldSlot) {
        headerText = `Select Item for ${subSlot} hand`;
    } else if (slot instanceof BackSlot) {
        headerText = `Select Item for Back`;
    } else {
        headerText = `Select Item for ${slotName}`; // Fallback
    }

    header.textContent = headerText;
    body.innerHTML = '';

    if (compatibleItems.length === 0) {
        body.innerHTML = '<p>No compatible items in inventory.</p>';
    } else {
        const list = document.createElement('ul');
        compatibleItems.forEach(item => {
            const listItem = document.createElement('li');
            listItem.textContent = item.name;
            const equipBtn = document.createElement('button');
            equipBtn.textContent = 'Equip';
            equipBtn.className = 'overlayBtn';
            equipBtn.style.marginLeft = '1rem';
            equipBtn.onclick = () => {
                equipItem(item.id, subSlot);
                document.getElementById('sub-overlay').style.display = 'none';
                buildEquipmentTab();
                updateCharDesc();
            };
            listItem.appendChild(equipBtn);
            list.appendChild(listItem);
        });
        body.appendChild(list);
    }

    subOverlay.style.display = 'block';
}

function buildEquipmentTab() {
    const equipmentDiv = document.getElementById('char-equipment');
    equipmentDiv.innerHTML = ''; // Clear previous content

    // Main container with 3-column layout
    const container = document.createElement('div');
    container.style.display = 'flex';
    container.style.justifyContent = 'space-between';
    container.style.height = '100%';

    // Define columns
    const leftCol = document.createElement('div');
    leftCol.style.flexBasis = '30%';
    leftCol.style.display = 'flex';
    leftCol.style.flexDirection = 'column';
    leftCol.style.gap = '0.5rem';
    leftCol.style.overflowY = 'auto';
    leftCol.style.alignItems = 'flex-end'; // Align widgets to the right of the left column

    const centerCol = document.createElement('div');
    centerCol.style.flexBasis = '40%';
    centerCol.style.display = 'flex';
    centerCol.style.justifyContent = 'center';
    centerCol.style.alignItems = 'center';
    centerCol.style.position = 'relative'; // Needed for positioning the overlay

    const rightCol = document.createElement('div');
    rightCol.style.flexBasis = '30%';
    rightCol.style.display = 'flex';
    rightCol.style.flexDirection = 'column';
    rightCol.style.gap = '0.5rem';
    rightCol.style.overflowY = 'auto';
    rightCol.style.alignItems = 'flex-start'; // Align widgets to the left of the right column

    // --- ASCII Art as background ---
    const asciiArt = `
                                                                                                                ████████
                                                                                                             ███        ███████████
                                                                                                          ███                      ██
                                                                                                        ███                          ██
                                                                                                      ████                             ██
                                                                                                     ████                               ██
                                                                                                    █████                                ██
                                                                                                   █████                                  ██
                                                                                                  ██████                                   ██
                                                                                                 ██████                                     █
                                                                                                 █████    █                                 ██
                                                                                                ██████   ██                                 ██
                                                                                                ██████   ██                                  ██
                                                                                               ███████  ███                     █             █
                                                                                               ███████ █████                     █            ██
                                                                                              ███████████████                     █            ██
                                                                                             ██████████████████                    █             █
                                                                                            ████████████████████                    ██            █
                                                                                           █████████████████████                    ████          ██
                                                                                           ██████████████    ███                     ████          █
                                                                                           ███████████████   ███                     █████         █
                                                                                           ██████  █████████████                      ███          ██
                                                                                           ████ █  █████████████                    ████          ██
                                                                                            ████ ████████████████                   ███           ██
                                                                                             ██████████████████                    ███            █
                                                                                              █████████████████                   ████           ██
                                                                                              █████████████████                   ███            ██
                                                                                              ██████████████████                  ██             ██
                                                                                         ███ ███████████████████                  ██             ███ ██
                                                                                          ███████████████████████         █       ██           ███████
                                                                                           █████████████████████████████           █           █████
                                                                                              ███████████████████████              ██    █████████
                                                                                                █████████████████                 ████████████████
                                                                                                     ███████████                   ████████████
                                                                                                         ██████                    █
                                                                                                      █████████                     ██
                                                                                                  ████████████                        ██
                                                                                             █████                                      ██████
                                                                                    ███████████                                               ████████
                                                                                 ████                                                                 ████
                                                                              ████                                                                        ██
                                                                             ███                                                                            ██
                                                                            ███                                                                               █
                                                                          ████                                                                                ██
                                                                         ████                                                                                 ██
                                                                        ████                                                                                   ██
                                                                       ████                                                                                    ██
                                                                      ████                                                                                      █
                                                                     ████                                                                                       █
                                                                    ████             ██████                                                                     ██
                                                                  ██████            ████████                                                                    ██
                                                                 █████              █████████                                                        █          █
                                                               ██████              ███████████                                                       █          ██
                                                              ██████               ███████████                                                       █          ██
                                                             █████               █████████████                                                                  █
                                                           █████               ██████ ██████████                                                                █
                                                          ████               ██████    ██████████                                                               ██
                                                        █████               █████       █████████                                                               ██
                                                       ████                ████         ██████████                                                   ██         ██
                                                      ████                ████           ██████████                                                 ███         ██
                                                    █████               ████             ███████████                                                ███         ███
                                                   █████               ████              █████████████                                             ████          ██
                                                  █████              ████                 ███████████████                                       ███████          █
                                                 ████              █████                  ███████████████                                     █████████          ██
                                                ████             █████                     ████████                                               █████          ██
                                               ████             ████                        ███████                                               ██████         █
                                               ███            █████                         ███████                                             ████████          ██
                                              ████            ███                           ███████                                             ████████          █
                                              █████           ██                             ███████                                            ████████          ██
                                              ██████           ██                             ███████                                           ██ █████           █
                                              ██████            ██                            ███████                                           ██  ████           █
                                               ██████            ██                            ██████                                           ██  █████          █
                                                ███████           ██                           ██████                                           ██  █████           █
                                                 ███████           ██                          ██████                                           ██  ██████          █
                                                  ███████           ███                         █████                                           ██  ██████           █
                                                    ██████            ██                        ████                                             ██  ████            █
                                                     ███████           ██                       ████                                              █  ████             █
                                                       ███████          ██                     █████                                              ██ ███              █
                                                        ████████          ██                   █████                                               █████              █
                                                          ████████          ██               ████                                                   █████             ██
                                                            ████████          ██           ███████                           █                       █████             █
                                                              ████████          ██        ███ █████████                                               ████             █
                                                                ███████           ██    ███           ██                                               ███             █
                                                                  ███████           ██████   ██████                                                    ████            ██
                                                                    ██████          █████         ████                                                  ████           ██
                                                                      ██████       ██████   ████     ███                                                 ████          ██
                                                                         █████   ███████    ███████     ███                                              █████         █
                                                                           █████████████████       ████                                                   ████         █
                                                                             ████████████████████                                                          ████        ██
                                                                               █████████████████████                                                       █████       ██
                                                                                 ██████  █████                                                              ████       ██
                                                                                        ██████                                                              █████      █
                                                                                        █████                                                               █████      ██
                                                                                       █████                                                                 ████       █
                                                                                       ████                                                                  █████      █
                                                                                       ████                                                                   ████      █
                                                                                      █████                                                                   ████      █
                                                                                      █████                                                                   █████     ██
                                                                                      █████                                                                   █████     ██
                                                                                     ██████                                                                   █████     ██
                                                                                     ██████                                                                   █████      █
                                                                                    ██████                                                                    █████      ██
                                                                                    ██████                      █                      █                      ██ ██      ██
                                                                                    █████                        █                    █                       ██ ██      ██
                                                                                   ██████                         █  ████         █ ██                        ██ ██      █
                                                                                   ██████                          ██████████████████                         ███        ██
                                                                                  ██████                             ███████████████                          ███        ██
                                                                                  ██████                              █████████████                          ████        ██
                                                                                  █████                               ███   ███████                          ███          █
                                                                                 ██████                               ███   ███████                          ███          ██
                                                                                 ██████                               ███   ███████                         ████          ██
                                                                                 ██████                               ██   █████████                        ████          ██
                                                                                 █████                               ███   █████████                        █████   █      ██
                                                                                ██████                               ███   ████████                        ███ ██  ███     ██
                                                                                ██████                              ███    █████████                       ███ ██    ██   ███
                                                                                ██████                              ███    █████████                      ███  ██  █ ██  ███
                                                                                ██████                             ███     ████████                       ███  ███ ███   ██
                                                                                ██████                            ███      ████████                      ████  ██  ███   ██
                                                                               ██████                             ███      █████████                     ███   █  ███   ██
                                                                               ███████                           ███        ███████                     ████  █████  ████
                                                                               ██████                           ███         ████████                    ███  ████ █████
                                                                               ██████                          ████         ████████                    ███  ███████
                                                                               ██████                          ███          ████████                   ███   ███
                                                                               ██████                         ███           ████████                   ███
                                                                               ██████                        ████           ████████                  ████
                                                                               ██████                       ████            ████████                 ████
                                                                              ███████                      ████             ████████                 ███
                                                                              ███████                      ███              ████████                 ███
                                                                              ███████                     ████              ████████                ███
                                                                              ███████                    ████               ████████                ███
                                                                              ███████                    ████               ████████               ███
                                                                              ███████                   ████               █████████              ████
                                                                              ███████                    ██                ████████               ███
                                                                              ███████                   ███                ████████              ████
                                                                              ███████                   ██                 █████████             ███
                                                                              ████████                 ███                ██████████            ████
                                                                              ████████                 ███                ██████████            ███
                                                                              ███████                 ███                 ███████████          ████
                                                                              ███████                ████                 ███████████          ████
                                                                              ███████                ███                  ███████████         █████
                                                                             ███████                 ███                  ███████████        █████
                                                                             ███████              █  ██                   ███████████       ██████
                                                                            ████████           ███  ███                   ████████████     ███████
                                                                            ████████          ███   ███                   █████████████  █████████
                                                                            ███████          ███    ██                    █████████████ █████████
                                                                           ████████         ██     ███                     ██████████      ██████
                                                                           ████████               ███                      ███████████      █████
                                                                          █████████              ███                       ███████████     ██████
                                                                         ██████████        █    ███                        ████████████   ██  ███
                                                                         ████████              ███                         █████████           ██
                                                                        ██████████            ███                          ████████            ██
                                                                        ████████              ██                          █████████           ███
                                                                       ████████              ███                          █████████           ███
                                                                       ███████              ████                          █████████           ███
                                                                      ███████                ██                          ██████████           ███
                                                                      ███████                ██                          ███████████          ███
                                                                      ██████                 ██                          ██████████          ████
                                                                     ███████                 ██                         █████  ███           ███
                                                                     ███████                ███                         █████  ██            ███
                                                                     ██████                 ██                          █████  ██           ████
                                                                     ██████                 ██                          █████  ██           ███
                                                                     ██████                 ██                          █████  ██           ███
                                                                     █████                 ██                           ██████ ██          ███
                                                                     █████                 ██                           █████████          ███
                                                                     █████                ██                            ████████          ███
                                                                     █████               ██                             █████  █          ███
                                                                     ████                ██                             █████            ███
                                                                     █████              ██                              █████            ███
                                                                    █████             ███                               █████           ███
                                                                    █████             ██                                █████           ███
                                                                    █████            ███                                █████          ███
                                                                    █████            ██                                 █████          ███
                                                                    █████           ██                                  ████          ███
                                                                    █████          ███                                  ████          ███
                                                                    ████           ██                                   ████         ███
                                                                    █████          ██                                   ████         ███
                                                                    █████         ██                                    ████         ██
                                                                    ████          █                                     ████        ██
                                                                     ███         ██                                     ███         ██
                                                                     ███         ██                                     ███        ██
                                                                    ████        ██                                     ████        ██
                                                                    ████        ██                                    ████         ██
                                                                    ████       ██                                     ████        ███
                                                                   █████       ██                                     ████        ██
                                                                   ████        ██                                     ████        ██
                                                                   ████        ██                                     ████        ██
                                                                  ████        ███                                     ████         ██
                                                                 ███          ███                                     █████         █
                                                                ███          ███                                     ███████         ██
                                                              ████           ███                                     ███████          ██
                                                             ████           █████                                    ████████         ███
                                                           █████          ███████                                     ████████          ███
                                                        ██████           ███████                                         █████           █████
                                                      ██████             █████                                             ███                █
                                                    █████               ███                                                ████               ██
                                                    ███                 ██                                                  ██████            ██
                                                   ████               ███                                                    █████            ██
                                                    ████             ███                                                       ████        ███
                                                     █████          ██                                                           ███████████
                                                       █████████████
`;
    const pre = document.createElement('pre');
    pre.textContent = asciiArt;
    pre.style.position = 'absolute';
    pre.style.top = '50%';
    pre.style.left = '50%';
    pre.style.transform = 'translate(-50%, -50%)';
    pre.style.fontSize = '0.20vw';
    pre.style.lineHeight = '0.85';
    pre.style.fontFamily = 'monospace';
    pre.style.color = '#0c0';
    pre.style.zIndex = '-1'; // Put it behind the widgets
    centerCol.appendChild(pre);

    // --- Create and Place Slot Widgets ---
    const createSlotWidget = (slotId) => {
        const slot = state.equipment[slotId];
        const widget = document.createElement('div');
        widget.style.border = '1px solid #444';
        widget.style.padding = '0.5rem';
        widget.style.width = '150px';

        const nameDiv = document.createElement('div');
        nameDiv.style.fontWeight = 'bold';
        nameDiv.style.color = '#00ff00';
        nameDiv.style.marginBottom = '0.3rem';
        nameDiv.textContent = slot.name;
        widget.appendChild(nameDiv);

        const createLayerButton = (subSlot, subSlotName) => {
            const item = (slot instanceof BackSlot) ? slot.item : slot[subSlot];
            const button = document.createElement('button');
            
            // New Styling Logic
            button.style.background = '#222';
            button.style.border = '1px solid transparent'; // Dark border, no outline
            button.style.borderRadius = '4px';
            button.style.padding = '.15rem .6rem';
            button.style.cursor = 'pointer';
            button.style.width = '100%';
            button.style.textAlign = 'left';
            button.style.marginBottom = '0.1rem';
            button.style.whiteSpace = 'nowrap';
            button.style.overflow = 'hidden';
            button.style.textOverflow = 'ellipsis';
            
            const originalColor = item ? 'lightblue' : 'grey';
            button.style.color = originalColor;

            button.innerHTML = `<small>[${subSlotName} - ${item ? item.name : 'empty'}]</small>`;
            
            button.onmouseover = () => {
                button.style.color = '#00ff00'; // Green on hover
                button.style.borderColor = '#00ff00';
            };
            button.onmouseout = () => {
                button.style.color = originalColor; // Revert to original color
                button.style.borderColor = 'transparent';
            };

            button.onclick = () => {
                if (item) {
                    unequipItem(slotId, subSlot);
                } else {
                    openItemSelectionOverlay(slotId, subSlot);
                }
            };
            widget.appendChild(button);
        };

        if (slot instanceof EquipmentSlot) {
            createLayerButton('skin', 'Skin');
            createLayerButton('middle', 'Middle');
            createLayerButton('outer', 'Outer');
        } else if (slot instanceof HandHeldSlot) {
            createLayerButton('left', 'Left Hand');
            createLayerButton('right', 'Right Hand');
        } else if (slot instanceof BackSlot) {
            createLayerButton('item', 'Back');
        }
        return widget;
    };

    // Add widgets to columns
    leftCol.appendChild(createSlotWidget('neck'));
    leftCol.appendChild(createSlotWidget('arms'));
    leftCol.appendChild(createSlotWidget('hands'));
    leftCol.appendChild(createSlotWidget('legs'));
    leftCol.appendChild(createSlotWidget('hand-held'));

    rightCol.appendChild(createSlotWidget('head'));
    rightCol.appendChild(createSlotWidget('upper'));
    rightCol.appendChild(createSlotWidget('lower'));
    rightCol.appendChild(createSlotWidget('waist'));
    rightCol.appendChild(createSlotWidget('feet'));
    rightCol.appendChild(createSlotWidget('back'));


    // Append columns to container, and container to the main div
    container.appendChild(leftCol);
    container.appendChild(centerCol);
    container.appendChild(rightCol);
    equipmentDiv.appendChild(container);
}

function buildInventoryTab() {
    const inventoryDiv = document.getElementById('char-inventory');
    inventoryDiv.innerHTML = ''; // Clear previous content

    if (state.inventory.length === 0) {
        inventoryDiv.innerHTML = '<p>Your inventory is empty.</p>';
        return;
    }

    const list = document.createElement('ul');
    state.inventory.forEach(item => {
        const listItem = document.createElement('li');
        listItem.textContent = item.name;
        // We can add an "Equip" button here later
        list.appendChild(listItem);
    });

    inventoryDiv.appendChild(list);
}

function updateCharStatusTab() {
    const statusDiv = document.getElementById('char-status');
    if (!statusDiv) return;
    let text = "Maya is feeling ";
    const tirednessPct = getFillPct('tiredness');
    if (tirednessPct <= 20) text += "exhausted";
    else if (tirednessPct <= 50) text += "tired";
    else text += "well-rested";

    const stressPct = getFillPct('stress');
    if (stressPct > 80) text += " and is panicking.";
    else if (stressPct > 50) text += " and feels very stressed.";
    else text += ".";
    
    statusDiv.textContent = text;
}

function updateCharSkillsTab() {
    const skillsDiv = document.getElementById('char-skills');
    if (!skillsDiv) return;
    let html = '<div style="display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center;">';

    for (const skillName in state.skills) {
        const skill = state.skills[skillName];
        const expForNextLevel = getExpForLevel(skill.level);
        const progress = skill.level >= 20 ? 100 : Math.round((skill.exp / expForNextLevel) * 100);

        html += `
            <div style="border: 1px solid #444; padding: 0.5rem; width: 120px; box-sizing: border-box; text-align: center;">
                <div style="font-size: 0.8rem;">${skillName}<br>(Lvl ${skill.level})</div>
                <div style="background: #333; height: 10px; margin-top: 5px; border-radius: 2px; overflow: hidden;">
                    <div style="width: ${progress}%; height: 100%; background: lightblue; border-radius: 2px;"></div>
                </div>
            </div>
        `;
    }
    html += '</div>';
    skillsDiv.innerHTML = html;
}

function updateCharStatsTab() {
    const statsDiv = document.getElementById('char-stats');
    if (!statsDiv) return;
    let html = '<ul style="list-style-position: inside;">';
    for (const statName in state.stats) {
        const statValue = state.stats[statName];
        const formattedName = statName.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
        html += `<li>${formattedName}: ${statValue}</li>`;
    }
    html += '</ul>';
    statsDiv.innerHTML = html;
}

/* ==============================================================
   SOCIAL
   ============================================================== */
function buildSocialOverlay() {
    const body = document.querySelector('#btnSocial-overlay .overlayBody');
    if (!body) return;

    let html = '<div class="npc-grid" style="display: flex; flex-wrap: wrap; gap: 1rem; align-content: flex-start; height: 100%; overflow-y: auto;">';

    const knownNpcs = Object.keys(state.npcs).filter(npcName => !state.npcs[npcName].hidden);

    if (knownNpcs.length === 0) {
        html += '<p>You haven\'t met anyone yet.</p>';
    } else {
        for (const npcName of knownNpcs) {
            const npc = state.npcs[npcName];

            html += `<div class="npc-plate" style="border: 1px solid #444; padding: 1rem; width: 22%; box-sizing: border-box; min-height: 160px; display: flex; flex-direction: column; justify-content: space-between;">`;

            html += `<div><h4>${npcName}</h4>`;

            // Always show stats for visible NPCs
            html += createNpcStatBar('Love', npc.relationship, '#ff0000'); // Red
            html += createNpcStatBar('Lust', npc.attraction, '#ff69b4');   // Hot Pink
            html += createNpcStatBar('Trust', npc.trust, '#1e90ff');     // Dodger Blue
            html += createNpcStatBar('Fear', npc.fear, '#9932cc');       // Dark Orchid
            
            html += `</div></div>`; // Close h4 div and npc-plate
        }
    }
    html += '</div>';

    body.innerHTML = html;
}

function createNpcStatBar(statName, value, barColor = '#4a90e2') {
    const percentage = Math.max(0, Math.min(100, value));

    return `
        <div class="npc-stat-bar-container" style="display: flex; align-items: center; margin-bottom: 0.3rem;">
            <span style="width: 80px; font-size: 0.9em; text-align: right; margin-right: 5px;">${statName}</span>
            <div class="bar" style="flex-grow: 1; height: 8px; background: #444; border-radius: 2px;">
                <div class="fill" style="width: ${percentage}%; height: 100%; background: ${barColor}; border-radius: 2px;"></div>
            </div>
        </div>
    `;
}
function cheatAddAllSkillsExp(amount) {
    for (const skillName in state.skills) {
        addSkillExp(skillName, amount);
    }
    // Visually update the character screen if it's open
    if (document.getElementById('btnChar-overlay').style.display === 'block') {
        updateCharSkillsTab();
    }
}

function cheatAddSkillExp(skillName, amount) {
    addSkillExp(skillName, amount);
    buildCheatOverlay();
    if (document.getElementById('btnChar-overlay').style.display === 'block') {
        updateCharSkillsTab();
    }
}



/* ==============================================================
   HEADER (date | time | money)
   ============================================================== */
function updateHeader(){
  document.getElementById('clock').textContent = fmtHM(state.currentTime);
  document.getElementById('date' ).textContent = fmtDate(state.currentTime);
  document.getElementById('money').textContent = formatMoney(state.money);
}

/* ==============================================================
   NEEDS UI
   ============================================================== */
function getFillPct(k){
  const cur = state.needs[k];
  const max = state.ranges[k];
  return Math.min(100, Math.max(0, (cur / max) * 100));
}

/* Simple stage labels (just for visual flavour) */
function stageLabel(p){
  if(p===0) return 'Stage 0';
  if(p<=33) return 'Stage 1';
  if(p<=66) return 'Stage 2';
  if(p<=99) return 'Stage 3';
  if(p=100) return 'Stage 4';
}

function updateNeedsUI(){
  Object.keys(state.needs).forEach(k=>{
    const el   = document.getElementById(`need-${k}`);
    if(!el) return;

    const pct  = getFillPct(k);                     // 0‑100 %
    const fill = el.querySelector('.fill');
    const line = el.querySelector('.needLine');

/* ---------- colour (custom logic) ---------- */
const inverted = ['stress','trauma','arousal'].includes(k);
const barColor =
  k === 'corruption' ? 'purple' :
  k === 'alcohol' ? 'orange' :
  k === 'drugs' ? 'lightsalmon' :
  (() => {
    const r = Math.round(255 * (inverted ? pct/100 : 1-pct/100));
    const g = Math.round(255 * (inverted ? 1-pct/100 : pct/100));
    return `rgb(${r},${g},0)`;
  })();

    fill.style.width = pct + '%';
    fill.style.background = barColor;               // thin bar colour
    

    /* ---------- stage label ---------- */
    const labels = el.getAttribute('data-labels').split('|');
    const idx = Math.min(labels.length-1, Math.floor(pct/20)); // 0‑4
    const stage = labels[idx];

    /* ---------- compose “Name: Stage” line ----------
       – for normal needs we show the name, for hidden ones we hide it
    */
    const needName = el.getAttribute('data-name');
    if(el.classList.contains('noName')){
      // hidden needs: only the stage (no name)
      line.innerHTML = `<span class="stage" style="color:${barColor};">${stage}</span>`;
    }else{
      // normal needs: “Name: Stage” on one line
      line.innerHTML = `
        <span style="color:#fff;">${needName}:</span>
        <span class="stage" style="color:${barColor}; margin-left:.4rem;">${stage}</span>
      `;
    }

    /* ---------- tooltip (name white + % coloured) ---------- */
    const tooltip = el.querySelector('.tooltip');
    tooltip.innerHTML = `
      <span style="color:#fff;">${needName}</span>
      <span style="color:${barColor}; margin-left:.4rem;">${pct.toFixed(0)}%</span>
    `;

    /* ---------- empty‑text colour handling (unchanged) ---------- */
    if(!inverted && pct===0 && !el.classList.contains('noName')){
      line.classList.add('empty');
    }else{
      line.classList.remove('empty');
    }
  });

  /* ---- visibility of the “bad” needs (unchanged) ---- */
  document.getElementById('need-alcohol')
          .style.display = state.needs.alcohol>0 ? 'block' : 'none';
  document.getElementById('need-drugs')
          .style.display = state.needs.drugs>0 ? 'block' : 'none';

  const corr = document.getElementById('need-corruption');
  if(state.showCorruption){
    corr.classList.remove('hiddenBar');
    corr.style.display = 'block';
  }else{
    corr.classList.add('hiddenBar');
    corr.style.display = 'none';
  }
}

/* ==============================================================
   SCREEN SWITCHING
   ============================================================== */
function switchScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

/* ==============================================================
   INTRO EVENT SEQUENCE (no time advance while reading)
   ============================================================== */
function showCurrentEvent(){
  const c = document.getElementById('mainArea');
  c.innerHTML = '';

  const ev = state.events[state.eventIndex];

  if (ev.reveals && state.npcs[ev.reveals]) {
    state.npcs[ev.reveals].hidden = false;
  }

  const title = document.createElement('h2');
  title.className = 'eventTitle';
  title.textContent = ev.title;
  c.appendChild(title);

  const txt = document.createElement('p');
  txt.className = 'eventText';
  txt.textContent = ev.text;
  c.appendChild(txt);

  const link = document.createElement('span');
  link.className = 'link';
  link.textContent = (state.eventIndex < state.events.length-1) ? 'Continue →' : 'Enter the Lab →';
  link.onclick = () => {
    if(state.eventIndex < state.events.length-1){
      state.eventIndex++;
      showCurrentEvent();          // **no** advanceTime here
    }else{
      state.storyEventActive = false; // Intro is over
      goToScene('foyer', 30);      // entering the lab starts the map
    }
  };
  c.appendChild(link);
}

/* ==============================================================
   MAP – FOYER AND ROOMS (each move advances time)
   ============================================================== */
function renderScene(sceneName) {
  state.currentLocation = sceneName;
  const sceneData = state.scenes[sceneName];
  if (!sceneData) return; // Or show an error scene

  const c = document.getElementById('mainArea');
  c.innerHTML = `
    <h2 class="eventTitle">${sceneData.title}</h2>
    <p class="eventText" id="sceneDesc">${sceneData.description}</p>
    <div class="navColumn" id="sceneNav"></div>
  `;

  const nav = document.getElementById('sceneNav');
  let navHtml = '';
  sceneData.nav.forEach(link => {
    let showLink = true;
    if (link.condition) {
      if (link.condition.type === 'npc_relationship') {
        const npc = state.npcs[link.condition.npc];
        if (!npc || npc.relationship < link.condition.value) {
          showLink = false;
        }
      }
      // Future condition types can be added here
    }

    if (showLink) {
      navHtml += `<span class="link" onclick="${link.action}">${link.text}</span>`;
    }
  });
  nav.innerHTML = navHtml;

  positionNavBelow(document.getElementById('sceneDesc'), nav);
}

function goToScene(sceneName, seconds) {
  if (seconds > 0) {
    advanceTime(seconds);
  }

  // --- NEW RANDOM EVENT LOGIC ---
  const destinationScene = state.scenes[sceneName];
  if (destinationScene && destinationScene.randomEvents) {
    for (const event of destinationScene.randomEvents) {
      if (Math.random() < event.chance) {
        // The random event triggered!
        renderScene(event.scene); // Go to the event scene instead
        return; // Stop processing further
      }
    }
  }

  // If no random event triggered, render the original destination
  renderScene(sceneName);
}

function finishShower() {
  advanceTime(600); // 10 minutes
  goToScene('bathroom', 0);
}

function finishRelaxing() {
  // 1. Pass time, but don't update the UI yet
  advanceTime(1800, false);

  // 2. Apply the stat bonuses
  let newHappiness = state.needs.happiness + 50;
  if (newHappiness > state.ranges.happiness) {
    newHappiness = state.ranges.happiness;
  }
  state.needs.happiness = newHappiness;

  let newTiredness = state.needs.tiredness + 250;
  if (newTiredness > state.ranges.tiredness) {
    newTiredness = state.ranges.tiredness;
  }
  state.needs.tiredness = newTiredness;

  // 3. Now, update the UI with the final values
  forceGlobalUIRefresh();
  checkStatTriggers();

  // 4. Go back to the lounge
  goToScene('lounge', 0);
}

function recoverFromStressCollapse() {
  // Set stress to 35% and increase trauma by 10%
  state.needs.stress = state.ranges.stress * 0.35;
  state.needs.trauma = Math.min(state.ranges.trauma, state.needs.trauma + (state.ranges.trauma * 0.1));
  state.stats.timesCollapsedFromStress++;

  // Go back to the previous location after a 1-hour time penalty
  goToScene(state.locationBeforeEvent, 3600);
}

function recoverFromArousalMax() {
  // Reset arousal and increment counter
  state.needs.arousal = 0;
  state.stats.timesClimaxed++;

  // Go back to the previous location after a 10-minute time penalty
  goToScene(state.locationBeforeEvent, 600);
}

/* Helper – positions a .navColumn just below a given element */
function positionNavBelow(targetEl, navEl){
  const parent = document.getElementById('mainArea').getBoundingClientRect();
  const tgt    = targetEl.getBoundingClientRect();
  const pct = ((tgt.bottom - parent.top) / parent.height) * 100;
  navEl.style.top = `${pct + 2}%`;   // small gap
}

function goToTailorHub() {
    const tailorScene = state.scenes.tailor_hub;
    tailorScene.nav = [];
    for (const slotId in state.equipment) {
        if (slotId !== 'hand-held' && slotId !== 'back') {
            tailorScene.nav.push({
                text: state.equipment[slotId].name,
                action: `goToTailorCrafting('${slotId}')`
            });
        }
    }
    tailorScene.nav.push({ text: 'Back to Foyer', action: "goToScene('foyer', 0)" });
    goToScene('tailor_hub', 0);
}

function goToTailorCrafting(slotId) {
    const mainArea = document.getElementById('mainArea');
    const templates = Object.values(clothingTemplates).filter(t => t.slot === slotId);

    let html = `
        <h2 class="eventTitle">Crafting: ${state.equipment[slotId].name}</h2>
        <p class="eventText">Select a template to craft:</p>
        <div class="navColumn">
    `;

    templates.forEach(template => {
        html += `<span class="link" onclick="craftItem('${template.id}')">${template.name} ($50)</span>`;
    });

    html += `<span class="link" onclick="goToTailorHub()">Back</span>`;
    html += `</div>`;

    mainArea.innerHTML = html;
    positionNavBelow(mainArea.querySelector('.eventText'), mainArea.querySelector('.navColumn'));
}

function craftItem(templateId) {
    const template = clothingTemplates[templateId];
    if (!template) return;

    const price = 50;
    if (state.money < price) {
        alert("You don't have enough money.");
        return;
    }

    const itemName = prompt(`Enter a name for your new ${template.name}:`, template.name);
    if (!itemName) return; // User cancelled

    state.money -= price;

    const newItem = new ClothingItem({
        ...template,
        id: `${template.id}_${Date.now()}`, // Unique ID
        name: itemName
    });

    state.inventory.push(newItem);
    alert(`You crafted a ${itemName} and it has been added to your inventory.`);
    updateHeader();
    goToTailorCrafting(template.slot); // Go back to the crafting screen
}

/* ==============================================================
   BOTTOM BUTTONS & OVERLAYS
   ============================================================== */
function initBottomButtons(){
  // Character / Social / Journal / Saves – placeholder handlers (you can flesh out)
  document.getElementById('btnChar'   ).onclick = () => openOverlay('btnChar');
  document.getElementById('btnSocial' ).onclick = () => openOverlay('btnSocial');
  document.getElementById('btnJournal').onclick = () => openOverlay('btnJournal');
  document.getElementById('btnSaves'  ).onclick = () => openOverlay('btnSaves');

  // Settings button – opens its overlay
  document.getElementById('btnSettings').onclick = () => openOverlay('btnSettings');

  // Cheats button – appears only after the checkbox is ticked
  document.getElementById('cheatsBtn'  ).onclick = () => openOverlay('cheatsBtn');
}

/* Generic overlay toggler (click again to hide) */
function openOverlay(btnId){
  const ov = document.getElementById(`${btnId}-overlay`);
  if(!ov) return;

  if(ov.style.display === 'block'){
    ov.style.display = 'none';
  }else{
    closeAllOverlays();
    ov.style.display = 'block';

    // Populate overlays with dynamic content when they are opened
    if (btnId === 'btnSettings') {
        // Check the current font and font size radio buttons
        document.querySelectorAll(`input[name="font"][value="${state.settings.fontFamily}"]`).forEach(el => el.checked = true);
        document.querySelectorAll(`input[name="fontsize"][value="${state.settings.fontSize}"]`).forEach(el => el.checked = true);
    } else if (btnId === 'btnChar') {
        showCharTab('status');
    } else if (btnId === 'btnSocial') {
        buildSocialOverlay();
    } else if (btnId === 'btnJournal') {
        buildJournalOverlay();
    } else if (btnId === 'btnSaves') {
        buildSavesOverlay();
    } else if (btnId === 'loadBtn') {
        buildLoadScreen();
    } else if (btnId === 'cheatsBtn') {
        buildCheatOverlay();
    }
  }
}

/* Hide every overlay */
function closeAllOverlays(){
  document.querySelectorAll('.overlay').forEach(o=>o.style.display='none');
}

/* --------------------------------------------------------------
   SETTINGS → CHEATS CHECKBOX
   -------------------------------------------------------------- */
function toggleCheats(cb){
  state.cheatsEnabled = cb.checked;
  applyCheatsUI();
}

function applyCheatsUI() {
  const cheatsEnabled = state.cheatsEnabled;

  const cheatsChk = document.getElementById('cheatsChk');
  if (cheatsChk) {
    cheatsChk.checked = cheatsEnabled;
  }

  if (cheatsEnabled) {
    document.body.classList.add('cheats-enabled');
  } else {
    document.body.classList.remove('cheats-enabled');
  }

  const cheatsBtn = document.getElementById('cheatsBtn');
  if (cheatsBtn) {
    cheatsBtn.style.display = cheatsEnabled ? 'inline-block' : 'none';
  }
}

/* --------------------------------------------------------------
   CHEAT OVERLAY & HELPERS
   -------------------------------------------------------------- */
function cheatModifyNpcStat(npcName, stat, amount) {
    if (state.npcs[npcName]) {
        state.npcs[npcName][stat] = Math.max(0, Math.min(100, state.npcs[npcName][stat] + amount));
        buildCheatOverlay(); // Redraw cheats to update value
        if (document.getElementById('btnSocial-overlay').style.display === 'block') {
            buildSocialOverlay();
        }
    }
}

function cheatModifyNeed(key, delta) {
  const max = state.ranges[key];
  const min = 0;
  state.needs[key] = Math.min(max, Math.max(min, state.needs[key] + delta));
  updateNeedsUI();
  buildCheatOverlay(); // Redraw cheats to update value
  checkStatTriggers();
}

// This helper function creates the new standardized row for any cheat
function createCheatControlRow(config) {
    // config: { label, value, neg_actions, pos_actions }
    return `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.4rem 0.2rem; border-bottom: 1px solid #333;">
            <span style="flex-basis: 30%; font-size: 0.9em;">${config.label}</span>
            <div style="flex-basis: 70%; display: flex; justify-content: flex-end; align-items: center; gap: 0.3rem;">
                <button class="overlayBtn" onclick="${config.neg_actions[0].onclick}">${config.neg_actions[0].label}</button>
                <button class="overlayBtn" onclick="${config.neg_actions[1].onclick}">${config.neg_actions[1].label}</button>
                <button class="overlayBtn" onclick="${config.neg_actions[2].onclick}">${config.neg_actions[2].label}</button>
                <span style="min-width: 6ch; text-align: center; font-weight: bold;">${config.value}</span>
                <button class="overlayBtn" onclick="${config.pos_actions[0].onclick}">${config.pos_actions[0].label}</button>
                <button class="overlayBtn" onclick="${config.pos_actions[1].onclick}">${config.pos_actions[1].label}</button>
                <button class="overlayBtn" onclick="${config.pos_actions[2].onclick}">${config.pos_actions[2].label}</button>
            </div>
        </div>
    `;
}

function showCheatTab(tabName) {
    document.querySelectorAll('.cheat-tab-content').forEach(el => el.style.display = 'none');
    document.getElementById(`cheat-tab-${tabName}`).style.display = 'block';
}

function buildCheatOverlay() {
    const body = document.querySelector('#cheatsBtn-overlay .overlayBody');
    body.style.height = 'calc(100% - 2rem)';
    body.style.overflowY = 'hidden';

    // --- Remember current tab ---
    let activeTab = 'general';
    const activeTabEl = document.querySelector('.cheat-tab-content[style*="display: block"]');
    if (activeTabEl) {
        activeTab = activeTabEl.id.replace('cheat-tab-', '');
    }

    // --- Tab Setup ---
    body.innerHTML = `
        <div id="cheat-tabs" style="display: flex; justify-content: center; margin-bottom: 1rem; gap: 0.5rem;">
            <button class="overlayBtn" style="flex-grow: 1;" onclick="showCheatTab('general')">General</button>
            <button class="overlayBtn" style="flex-grow: 1;" onclick="showCheatTab('skills')">Skills</button>
            <button class="overlayBtn" style="flex-grow: 1;" onclick="showCheatTab('npcs')">NPCs</button>
        </div>
        <div id="cheat-tab-general" class="cheat-tab-content" style="height: 90%; overflow-y: auto;"></div>
        <div id="cheat-tab-skills" class="cheat-tab-content" style="display: none; height: 90%; overflow-y: auto;"></div>
        <div id="cheat-tab-npcs" class="cheat-tab-content" style="display: none; height: 90%; overflow-y: auto;"></div>
    `;

    // --- Build General Tab ---
    const generalTab = document.getElementById('cheat-tab-general');
    let generalContent = '<div style="display: flex; gap: 2rem;">';

    // Left Column
    let leftCol = '<div style="flex-basis: 50%;">';
    leftCol += '<h4 style="text-align: center;">Needs</h4>';
    for (const key in state.needs) {
        const max = state.ranges[key];
        leftCol += createCheatControlRow({
            label: key.charAt(0).toUpperCase() + key.slice(1),
            value: `${state.needs[key].toFixed(0)}`,
            neg_actions: [ { label: '-50%', onclick: `cheatModifyNeed('${key}', -${max*0.5})` }, { label: '-10%', onclick: `cheatModifyNeed('${key}', -${max*0.1})` }, { label: '-1%', onclick: `cheatModifyNeed('${key}', -${max*0.01})` } ],
            pos_actions: [ { label: '+1%', onclick: `cheatModifyNeed('${key}', ${max*0.01})` }, { label: '+10%', onclick: `cheatModifyNeed('${key}', ${max*0.1})` }, { label: '+50%', onclick: `cheatModifyNeed('${key}', ${max*0.5})` } ]
        });
    }
    leftCol += '</div>';

    // Right Column
    let rightCol = '<div style="flex-basis: 50%;">';
    rightCol += '<h4 style="text-align: center;">Money & Toggles</h4>';
    rightCol += createCheatControlRow({
        label: "Money", value: `$${state.money.toFixed(2)}`,
        neg_actions: [ { label: '-1k', onclick: `cheatMoney(-1000)` }, { label: '-100', onclick: `cheatMoney(-100)` }, { label: '-10', onclick: `cheatMoney(-10)` } ],
        pos_actions: [ { label: '+10', onclick: `cheatMoney(10)` }, { label: '+100', onclick: `cheatMoney(100)` }, { label: '+1k', onclick: `cheatMoney(1000)` } ]
    });
    rightCol += `<div style="text-align: center; padding: 1rem;"><label><input type="checkbox" onchange="toggleCorruptionDisplay(this)" ${state.showCorruption?'checked':''}> Show Corruption Bar</label></div>`;
    rightCol += '</div>';

    generalContent += leftCol + rightCol + '</div>';
    generalTab.innerHTML = generalContent;


    // --- Build Skills Tab (2 columns) ---
    const skillsTab = document.getElementById('cheat-tab-skills');
    let skillsHtml = '<h4 style="text-align: center;">Skills</h4><div style="display: flex; gap: 1rem;">';
    const skills = Object.keys(state.skills);
    const mid = Math.ceil(skills.length / 2);
    const col1 = skills.slice(0, mid);
    const col2 = skills.slice(mid);
    let col1Html = '<div style="flex-basis: 50%;">';
    col1.forEach(skillName => {
        col1Html += createCheatControlRow({
            label: skillName, value: `${state.skills[skillName].exp.toFixed(0)} exp`,
            neg_actions: [ {label: '-64', onclick:`cheatAddSkillExp('${skillName}', -64)`}, {label: '-8', onclick:`cheatAddSkillExp('${skillName}', -8)`}, {label: '-1', onclick:`cheatAddSkillExp('${skillName}', -1)`} ],
            pos_actions: [ {label: '+1', onclick:`cheatAddSkillExp('${skillName}', 1)`}, {label: '+8', onclick:`cheatAddSkillExp('${skillName}', 8)`}, {label: '+64', onclick:`cheatAddSkillExp('${skillName}', 64)`} ],
        });
    });
    col1Html += '</div>';
    let col2Html = '<div style="flex-basis: 50%;">';
    col2.forEach(skillName => {
        col2Html += createCheatControlRow({
            label: skillName, value: `${state.skills[skillName].exp.toFixed(0)} exp`,
            neg_actions: [ {label: '-64', onclick:`cheatAddSkillExp('${skillName}', -64)`}, {label: '-8', onclick:`cheatAddSkillExp('${skillName}', -8)`}, {label: '-1', onclick:`cheatAddSkillExp('${skillName}', -1)`} ],
            pos_actions: [ {label: '+1', onclick:`cheatAddSkillExp('${skillName}', 1)`}, {label: '+8', onclick:`cheatAddSkillExp('${skillName}', 8)`}, {label: '+64', onclick:`cheatAddSkillExp('${skillName}', 64)`} ],
        });
    });
    col2Html += '</div>';
    skillsTab.innerHTML = skillsHtml + col1Html + col2Html + '</div>';

    // --- Build NPCs Tab (2 columns) ---
    const npcsTab = document.getElementById('cheat-tab-npcs');
    let npcsHtml = '<h4 style="text-align: center;">NPCs</h4><div style="display: flex; gap: 1rem;">';
    const npcs = Object.keys(state.npcs);
    const npcMid = Math.ceil(npcs.length / 2);
    const npcCol1 = npcs.slice(0, npcMid);
    const npcCol2 = npcs.slice(npcMid);
    let npcCol1Html = '<div style="flex-basis: 50%;">';
    npcCol1.forEach(npcName => {
        npcCol1Html += `<h5 style="text-align:center;">${npcName}</h5>`;
        for(const stat in state.npcs[npcName]) {
            if(typeof state.npcs[npcName][stat] === 'number') {
                npcCol1Html += createCheatControlRow({
                    label: stat.charAt(0).toUpperCase() + stat.slice(1), value: state.npcs[npcName][stat],
                    neg_actions: [ {label: '-25', onclick:`cheatModifyNpcStat('${npcName}', '${stat}', -25)`}, {label: '-5', onclick:`cheatModifyNpcStat('${npcName}', '${stat}', -5)`}, {label: '-1', onclick:`cheatModifyNpcStat('${npcName}', '${stat}', -1)`} ],
                    pos_actions: [ {label: '+1', onclick:`cheatModifyNpcStat('${npcName}', '${stat}', 1)`}, {label: '+5', onclick:`cheatModifyNpcStat('${npcName}', '${stat}', 5)`}, {label: '+25', onclick:`cheatModifyNpcStat('${npcName}', '${stat}', 25)`} ]
                });
            }
        }
    });
    npcCol1Html += '</div>';
    let npcCol2Html = '<div style="flex-basis: 50%;">';
    npcCol2.forEach(npcName => {
        npcCol2Html += `<h5 style="text-align:center;">${npcName}</h5>`;
        for(const stat in state.npcs[npcName]) {
            if(typeof state.npcs[npcName][stat] === 'number') {
                npcCol2Html += createCheatControlRow({
                    label: stat.charAt(0).toUpperCase() + stat.slice(1), value: state.npcs[npcName][stat],
                    neg_actions: [ {label: '-25', onclick:`cheatModifyNpcStat('${npcName}', '${stat}', -25)`}, {label: '-5', onclick:`cheatModifyNpcStat('${npcName}', '${stat}', -5)`}, {label: '-1', onclick:`cheatModifyNpcStat('${npcName}', '${stat}', -1)`} ],
                    pos_actions: [ {label: '+1', onclick:`cheatModifyNpcStat('${npcName}', '${stat}', 1)`}, {label: '+5', onclick:`cheatModifyNpcStat('${npcName}', '${stat}', 5)`}, {label: '+25', onclick:`cheatModifyNpcStat('${npcName}', '${stat}', 25)`} ]
                });
            }
        }
    });
    npcCol2Html += '</div>';
    npcsTab.innerHTML = npcsHtml + npcCol1Html + npcCol2Html + '</div>';

    showCheatTab(activeTab);
}

/* optional money cheat – keeps two‑decimal precision */
function cheatMoney(delta){
  state.money = Math.round((state.money + delta) * 100) / 100;
  updateHeader();
}

/* toggle the hidden “Corruption” bar */
function toggleCorruptionDisplay(cb){
  state.showCorruption = cb.checked;
  updateNeedsUI();
}

/* --------------------------------------------------------------
   INITIALISATION
   -------------------------------------------------------------- */
document.addEventListener('DOMContentLoaded', () => {
    const startBtn = document.getElementById('startBtn');
    if (startBtn) {
        startBtn.addEventListener('click', () => {
            // Set story flag to protect intro
            state.storyEventActive = true;

            // Initialise physical body
            state.playerBody = createPlayerBody(state.sex);

            // Switch to the main game screen
            switchScreen('gameScreen');

            // Initialise dynamic values
            state.money = 0.00;
            updateHeader();          // date | time | money row
            updateNeedsUI();         // draw need bars (all green at start)

            // Build UI pieces that depend on JS
            initBottomButtons();    // hook up the bottom‑button bar
            buildCheatOverlay();    // populate the Cheats overlay
            applySettings();        // apply default/loaded settings
            applyCheatsUI();        // apply default/loaded cheat settings

            // Create and equip starting gear
            const startingGear = [
                'upper_bra', 'lower_panties', 'upper_tshirt', 'lower_jeans', 'feet_sneakers',
                'back_backpack', 'handheld_handbag', 'hat_baseball_cap'
            ];
            
            state.inventory = startingGear.map(templateId => {
                const template = clothingTemplates[templateId];
                return new ClothingItem({
                    ...template,
                    id: `${template.id}_${Date.now()}_${Math.random()}` // Ensure unique ID
                });
            });

            // Equip the default outfit
            const equipStartingItem = (templateId, subSlot) => {
                const item = state.inventory.find(i => i.name === clothingTemplates[templateId].name);
                if (item) {
                    equipItem(item.id, subSlot);
                }
            };

            equipStartingItem('upper_bra', 'skin');
            equipStartingItem('lower_panties', 'skin');
            equipStartingItem('upper_tshirt', 'middle');
            equipStartingItem('lower_jeans', 'middle');
            equipStartingItem('feet_sneakers', 'outer');
            
            updateCharDesc();

            // Show the first intro event
            showCurrentEvent();
        });
    }

    const loadBtn = document.getElementById('loadBtn');
    if (loadBtn) {
        loadBtn.addEventListener('click', () => openOverlay('loadBtn'));
    }
});

</script>
</body>
</html>
